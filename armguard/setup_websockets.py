#!/usr/bin/env python3\n\"\"\"\nWebSocket Performance Enhancement Script\nInstalls Redis support and optimizes WebSocket configuration for ArmGuard\n\"\"\"\n\nimport subprocess\nimport sys\nimport os\n\ndef install_redis_support():\n    \"\"\"Install Redis and channels-redis for optimal WebSocket performance\"\"\"\n    \n    print(\"\ud83d\ude80 Installing Redis support for WebSockets...\")\n    print()\n    \n    packages = [\n        'redis>=4.3.4',\n        'channels-redis>=4.0.0'\n    ]\n    \n    success = True\n    \n    for package in packages:\n        try:\n            print(f\"\ud83d\udce6 Installing {package}...\")\n            subprocess.check_call([sys.executable, '-m', 'pip', 'install', package])\n            print(f\"\u2705 {package} installed successfully\")\n        except subprocess.CalledProcessError as e:\n            print(f\"\u274c Failed to install {package}: {e}\")\n            success = False\n        except Exception as e:\n            print(f\"\u274c Error installing {package}: {e}\")\n            success = False\n    \n    return success\n\ndef check_redis_server():\n    \"\"\"Check if Redis server is running\"\"\"\n    \n    print(\"\\n\ud83d\udd0d Checking Redis server...\")\n    \n    try:\n        import redis\n        client = redis.Redis(host='127.0.0.1', port=6379, db=1, socket_connect_timeout=2)\n        client.ping()\n        print(\"\u2705 Redis server is running and accessible\")\n        return True\n        \n    except ImportError:\n        print(\"\u274c Redis package not installed\")\n        return False\n        \n    except redis.exceptions.ConnectionError:\n        print(\"\u26a0\ufe0f Redis server not running or not accessible\")\n        print(\"   Solution options:\")\n        print(\"   1. Install Redis server: https://redis.io/download\")\n        print(\"   2. Use Docker: docker run -d -p 6379:6379 redis:alpine\")\n        print(\"   3. Use Windows Subsystem for Linux (WSL) with Redis\")\n        return False\n        \n    except Exception as e:\n        print(f\"\u274c Redis connection error: {e}\")\n        return False\n\ndef create_redis_docker_script():\n    \"\"\"Create a script to run Redis with Docker\"\"\"\n    \n    docker_script = '''@echo off\necho Starting Redis server with Docker...\necho.\n\n:: Check if Docker is running\ndocker version >nul 2>&1\nif errorlevel 1 (\n    echo Error: Docker is not running or not installed.\n    echo Please install Docker Desktop for Windows.\n    pause\n    exit /b 1\n)\n\n:: Stop any existing Redis container\ndocker stop armguard-redis >nul 2>&1\ndocker rm armguard-redis >nul 2>&1\n\n:: Start Redis container\necho Starting Redis container...\ndocker run -d --name armguard-redis -p 6379:6379 redis:alpine\n\nif errorlevel 0 (\n    echo.\n    echo \u2705 Redis server started successfully!\n    echo    - Host: 127.0.0.1\n    echo    - Port: 6379\n    echo    - Container: armguard-redis\n    echo.\n    echo To stop Redis later: docker stop armguard-redis\n) else (\n    echo.\n    echo \u274c Failed to start Redis container\n)\n\necho.\necho Press any key to continue...\npause >nul\n'''\n    \n    script_path = \"start_redis_docker.bat\"\n    \n    with open(script_path, 'w', encoding='utf-8') as f:\n        f.write(docker_script)\n    \n    print(f\"\ud83d\udcc4 Created {script_path}\")\n    return script_path\n\ndef test_websocket_functionality():\n    \"\"\"Test WebSocket functionality after setup\"\"\"\n    \n    print(\"\\n\ud83e\uddea Testing WebSocket functionality...\")\n    \n    try:\n        # Test channel layer configuration\n        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')\n        import django\n        django.setup()\n        \n        from channels.layers import get_channel_layer\n        from asgiref.sync import async_to_sync\n        \n        channel_layer = get_channel_layer()\n        \n        if channel_layer is None:\n            print(\"\u274c Channel layer not configured\")\n            return False\n        \n        print(f\"\u2705 Channel layer backend: {channel_layer.__class__.__name__}\")\n        \n        # Test basic channel operation\n        test_group = 'test_group_12345'\n        test_channel = 'test.channel.12345'\n        \n        # Test group operations\n        async_to_sync(channel_layer.group_add)(test_group, test_channel)\n        print(\"\u2705 Group add operation successful\")\n        \n        async_to_sync(channel_layer.group_discard)(test_group, test_channel)\n        print(\"\u2705 Group discard operation successful\")\n        \n        print(\"\u2705 WebSocket functionality test passed!\")\n        return True\n        \n    except ImportError as e:\n        print(f\"\u274c Import error: {e}\")\n        return False\n        \n    except Exception as e:\n        print(f\"\u274c WebSocket test error: {e}\")\n        return False\n\ndef main():\n    \"\"\"Main setup function\"\"\"\n    \n    print(\"ArmGuard WebSocket Performance Enhancement\")\n    print(\"=\" * 45)\n    print()\n    print(\"This script will optimize WebSocket performance by:\")\n    print(\"\u2022 Installing Redis support packages\")\n    print(\"\u2022 Configuring automatic fallback to InMemory if Redis unavailable\")\n    print(\"\u2022 Testing WebSocket functionality\")\n    print()\n    \n    # Step 1: Install Redis packages\n    if install_redis_support():\n        print(\"\\n\u2705 Redis packages installed successfully\")\n    else:\n        print(\"\\n\u26a0\ufe0f Some packages failed to install, but system may still work\")\n    \n    # Step 2: Check Redis server\n    redis_available = check_redis_server()\n    \n    # Step 3: Create Docker script for easy Redis setup\n    if not redis_available:\n        script_path = create_redis_docker_script()\n        print(f\"\\n\ud83d\udc33 Created Docker script: {script_path}\")\n        print(\"   Run this script to start Redis server with Docker\")\n    \n    # Step 4: Test functionality\n    if test_websocket_functionality():\n        print(\"\\n\ud83c\udf89 WebSocket system is working correctly!\")\n    else:\n        print(\"\\n\u26a0\ufe0f WebSocket test failed, but basic functionality should work\")\n    \n    # Final instructions\n    print(\"\\n\ud83c\udfc1 NEXT STEPS:\")\n    print(\"1. Restart your Django server to apply changes\")\n    \n    if redis_available:\n        print(\"2. \u2705 Redis is ready - optimal WebSocket performance enabled\")\n    else:\n        print(\"2. \u26a0\ufe0f For best performance, start Redis server:\")\n        print(\"   - Option A: Run start_redis_docker.bat (if you have Docker)\")\n        print(\"   - Option B: Install Redis server manually\")\n        print(\"   - Option C: System will use InMemory fallback (works but limited)\")\n    \n    print(\"3. WebSocket connections will now work without blocking issues\")\n    print(\"4. Real-time notifications and live updates are enabled\")\n    \n    print(\"\\n\ud83d\udd04 To restart Django server:\")\n    print(\"   Ctrl+C to stop current server, then: python manage.py runserver\")\n\nif __name__ == '__main__':\n    main()\n