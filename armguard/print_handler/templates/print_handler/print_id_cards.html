{% extends 'base.html' %}
{% load static %}

{% block title %}ID Card Print Manager - ArmGuard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .id-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1.25rem;
    }

    .id-card-item {
        background: var(--neutral-0, #fff);
        border: 1px solid var(--neutral-200, #e5e7eb);
        border-radius: 0.75rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: box-shadow 0.15s;
    }

    .id-card-item:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.10);
    }

    .id-card-item.selected {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px #2563eb44;
    }

    .id-card-thumb {
        width: 100%;
        aspect-ratio: 638 / 1013;
        object-fit: cover;
        background: #f3f4f6;
        display: block;
        cursor: pointer;
    }

    .id-card-no-image {
        width: 100%;
        aspect-ratio: 638 / 1013;
        background: linear-gradient(135deg, #1e40af, #2563eb);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: rgba(255,255,255,0.6);
        font-size: 2rem;
        gap: 0.5rem;
        cursor: default;
    }

    .id-card-no-image span {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .id-card-info {
        padding: 0.6rem 0.75rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .id-card-name {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--neutral-900, #111827);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .id-card-pid {
        font-size: 0.65rem;
        color: var(--neutral-500, #6b7280);
        font-family: 'Courier New', monospace;
    }

    .id-card-actions {
        padding: 0.5rem 0.75rem;
        display: flex;
        gap: 0.4rem;
        border-top: 1px solid var(--neutral-100, #f3f4f6);
    }

    .id-card-actions .btn {
        flex: 1;
        font-size: 0.7rem;
        padding: 0.3rem 0.4rem;
    }

    .select-checkbox {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        width: 1.1rem;
        height: 1.1rem;
        accent-color: #2563eb;
        cursor: pointer;
        z-index: 2;
    }

    .card-wrapper {
        position: relative;
    }

    .status-badge {
        font-size: 0.65rem;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        font-weight: 600;
        letter-spacing: 0.04em;
    }

    .badge-ok { background: #dcfce7; color: #166534; }
    .badge-missing { background: #fee2e2; color: #991b1b; }

    .regen-spinner { display: none; }
    .regen-icon { display: inline; }

    .toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }

    .toolbar-right {
        margin-left: auto;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="card mb-6 border-l-4" style="border-left-color: var(--armguard-primary);">
    <div class="p-6 d-flex" style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem;">
        <div>
            <h1 class="text-3xl font-bold text-neutral-900 m-0">
                <i class="fas fa-id-card text-primary"></i> Personnel ID Card Manager
            </h1>
            <p class="text-neutral-500 mt-1 mb-0" style="font-size:0.9rem;">
                Preview, print, and regenerate personnel ID card PNGs
            </p>
        </div>
        <a href="{% url 'print_handler:print_qr_codes' %}" class="btn btn-secondary btn-sm">
            <i class="fas fa-qrcode"></i> QR Code Printer
        </a>
    </div>
</div>

<!-- Stats -->
<div class="grid grid-cols-3 gap-4 mb-6">
    <div class="card p-4 text-center">
        <div style="font-size:1.8rem; font-weight:800; color:#2563eb;">{{ total }}</div>
        <div style="font-size:0.8rem; color:#6b7280; text-transform:uppercase; letter-spacing:0.06em;">Total Personnel</div>
    </div>
    <div class="card p-4 text-center">
        <div style="font-size:1.8rem; font-weight:800; color:#16a34a;">{{ with_card }}</div>
        <div style="font-size:0.8rem; color:#6b7280; text-transform:uppercase; letter-spacing:0.06em;">Cards Generated</div>
    </div>
    <div class="card p-4 text-center">
        <div style="font-size:1.8rem; font-weight:800; color:#dc2626;">{{ without_card }}</div>
        <div style="font-size:0.8rem; color:#6b7280; text-transform:uppercase; letter-spacing:0.06em;">Missing Cards</div>
    </div>
</div>

<!-- Toolbar -->
<div class="card mb-4">
    <div class="p-4">
        <div class="toolbar">
            <!-- Search -->
            <form method="get" style="display:flex; gap:0.5rem; flex:1; min-width:220px; max-width:380px;">
                <input type="text" name="q" value="{{ search_q }}" placeholder="Search name, ID, rank…"
                       class="form-control" style="font-size:0.875rem;">
                <button type="submit" class="btn btn-secondary btn-sm">
                    <i class="fas fa-search"></i>
                </button>
                {% if search_q %}
                <a href="{% url 'print_handler:print_id_cards' %}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-times"></i>
                </a>
                {% endif %}
            </form>

            <!-- Select-all checkbox -->
            <label style="display:flex; align-items:center; gap:0.4rem; font-size:0.875rem; cursor:pointer;">
                <input type="checkbox" id="select-all" style="width:1rem; height:1rem; accent-color:#2563eb;">
                Select All
            </label>

            <div class="toolbar-right">
                <!-- Print Selected -->
                <button id="btn-print-selected" class="btn btn-primary btn-sm" disabled onclick="printSelected()">
                    <i class="fas fa-print"></i> Print Selected
                </button>
                <!-- Print All -->
                <a href="{% url 'print_handler:print_id_cards_view' %}?all=1"
                   class="btn btn-success btn-sm" target="_blank">
                    <i class="fas fa-print"></i> Print All
                </a>
                <!-- Regenerate All Missing -->
                <button id="btn-regen-missing" class="btn btn-warning btn-sm" onclick="regenMissing()">
                    <i class="fas fa-sync-alt"></i> Generate Missing
                </button>
                <!-- Regenerate ALL (force, picks up newly available photos) -->
                <button id="btn-regen-all" class="btn btn-danger btn-sm" onclick="regenAll()"
                        title="Regenerate every card — use this when profile photos have changed or been migrated">
                    <i class="fas fa-redo"></i> Regenerate All
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Card Grid -->
<div class="card">
    <div class="p-6">
        {% if personnel_cards %}
        <div class="id-card-grid" id="card-grid">
            {% for entry in personnel_cards %}
            <div class="card-wrapper" data-pid="{{ entry.personnel.id }}" data-has-card="{{ entry.has_card|yesno:'1,0' }}">
                <input type="checkbox" class="select-checkbox card-checkbox"
                       value="{{ entry.personnel.id }}" aria-label="Select {{ entry.personnel.get_full_name }}">
                <div class="id-card-item" id="card-item-{{ entry.personnel.id|slugify }}">
                    {% if entry.thumb_url %}
                    <a href="{{ entry.thumb_url }}" target="_blank">
                        <img src="{{ entry.thumb_url }}" alt="ID Card front for {{ entry.personnel.get_full_name }}"
                             class="id-card-thumb" loading="lazy"
                             id="thumb-{{ entry.personnel.id|slugify }}">
                    </a>
                    {% else %}
                    <div class="id-card-no-image" id="thumb-{{ entry.personnel.id|slugify }}">
                        <i class="fas fa-id-card"></i>
                        <span>No Card</span>
                    </div>
                    {% endif %}

                    <div class="id-card-info">
                        <div class="id-card-name" title="{{ entry.personnel.get_full_name }}">
                            {{ entry.personnel.rank }} {{ entry.personnel.get_full_name }}
                        </div>
                        <div class="id-card-pid">{{ entry.personnel.id }}</div>
                        <div>
                            {% if entry.has_card %}
                            <span class="status-badge badge-ok"><i class="fas fa-check-circle"></i> Generated</span>
                            {% else %}
                            <span class="status-badge badge-missing" id="status-{{ entry.personnel.id|slugify }}">
                                <i class="fas fa-times-circle"></i> Missing
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="id-card-actions">
                        <button class="btn btn-secondary"
                                title="Regenerate Card"
                                onclick="regenCard('{{ entry.personnel.id }}', '{{ entry.personnel.id|slugify }}')"
                                id="regen-btn-{{ entry.personnel.id|slugify }}">
                            <span class="regen-icon-{{ entry.personnel.id|slugify }}"><i class="fas fa-sync-alt"></i></span>
                            <span class="regen-spinner-{{ entry.personnel.id|slugify }}" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i>
                            </span>
                        </button>
                        {% if entry.thumb_url %}
                        <a href="{% url 'print_handler:print_id_cards_view' %}?ids={{ entry.personnel.id }}"
                           target="_blank" class="btn btn-primary" title="Print this card">
                            <i class="fas fa-print"></i>
                        </a>
                        {% else %}
                        <button class="btn btn-primary" disabled title="Generate card first">
                            <i class="fas fa-print"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12" style="color:#6b7280;">
            <i class="fas fa-id-card" style="font-size:3rem; opacity:0.3;"></i>
            <p class="mt-3">No personnel found{% if search_q %} matching "{{ search_q }}"{% endif %}.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const REGEN_URL_BASE       = "{% url 'print_handler:regenerate_id_card' personnel_id='PLACEHOLDER' %}".replace('PLACEHOLDER', '');
const PRINT_VIEW_URL       = "{% url 'print_handler:print_id_cards_view' %}";
const GEN_MISSING_URL      = "{% url 'print_handler:generate_missing_cards' %}";
const CSRF_TOKEN = '{{ csrf_token }}';

// ---- Select All ----
document.getElementById('select-all').addEventListener('change', function () {
    const boxes = document.querySelectorAll('.card-checkbox');
    boxes.forEach(cb => {
        cb.checked = this.checked;
        cb.closest('.card-wrapper').querySelector('.id-card-item').classList.toggle('selected', this.checked);
    });
    updatePrintBtn();
});

document.addEventListener('change', function (e) {
    if (e.target.classList.contains('card-checkbox')) {
        e.target.closest('.card-wrapper').querySelector('.id-card-item').classList.toggle('selected', e.target.checked);
        updatePrintBtn();
    }
});

function updatePrintBtn() {
    const count = document.querySelectorAll('.card-checkbox:checked').length;
    const btn = document.getElementById('btn-print-selected');
    btn.disabled = count === 0;
    btn.innerHTML = `<i class="fas fa-print"></i> Print Selected${count ? ' (' + count + ')' : ''}`;
}

// ---- Print Selected ----
function printSelected() {
    const ids = [...document.querySelectorAll('.card-checkbox:checked')].map(cb => cb.value);
    if (!ids.length) return;
    window.open(PRINT_VIEW_URL + '?ids=' + ids.join(','), '_blank');
}

// ---- Regen Single ----
function regenCard(pid, slug) {
    const btn     = document.getElementById('regen-btn-' + slug);
    const iconEl  = document.querySelector('.regen-icon-' + slug);
    const spinEl  = document.querySelector('.regen-spinner-' + slug);

    btn.disabled = true;
    iconEl.style.display = 'none';
    spinEl.style.display = 'inline';

    fetch(REGEN_URL_BASE + pid + '/', {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json' }
    })
    .then(r => {
        const ct = r.headers.get('Content-Type') || '';
        if (!ct.includes('application/json')) {
            return r.text().then(t => { throw new Error('Server returned HTTP ' + r.status + ' (not JSON). Check server logs.'); });
        }
        return r.json();
    })
    .then(data => {
        if (data.success) {
            // Update thumbnail
            const thumbContainer = document.getElementById('thumb-' + slug);
            if (thumbContainer && thumbContainer.tagName === 'IMG') {
                thumbContainer.src = data.thumb_url + '?t=' + Date.now();
            } else if (thumbContainer) {
                // Replace placeholder div with an image link
                const link = document.createElement('a');
                link.href = data.thumb_url;
                link.target = '_blank';
                const img = document.createElement('img');
                img.src = data.thumb_url;
                img.className = 'id-card-thumb';
                img.id = 'thumb-' + slug;
                link.appendChild(img);
                thumbContainer.parentNode.replaceChild(link, thumbContainer);
            }
            // Update status badge
            const statusEl = document.getElementById('status-' + slug);
            if (statusEl) {
                statusEl.className = 'status-badge badge-ok';
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Generated';
                statusEl.id = '';
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => alert('Regenerate failed: ' + err))
    .finally(() => {
        btn.disabled = false;
        iconEl.style.display = 'inline';
        spinEl.style.display = 'none';
    });
}

// ---- Regen All (force) ----
function regenAll() {
    if (!confirm(
        `Regenerate ALL ${document.querySelectorAll('.card-wrapper').length} ID cards?\n\n` +
        'Use this when profile photos have been uploaded or migrated since cards were last generated.\n' +
        'This may take 30–60 seconds.'
    )) return;

    const btn = document.getElementById('btn-regen-all');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Regenerating all…';

    const form = new FormData();
    form.append('force', '1');

    fetch(GEN_MISSING_URL, {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF_TOKEN },
        body: form
    })
    .then(r => {
        const ct = r.headers.get('Content-Type') || '';
        if (!ct.includes('application/json')) {
            return r.text().then(() => { throw new Error('Server returned HTTP ' + r.status + ' (not JSON). Pull latest code and restart.'); });
        }
        return r.json();
    })
    .then(data => {
        if (data.success) {
            let msg = `Regenerated ${data.generated} cards.`;
            if (data.errors && data.errors.length) {
                msg += `\n\n${data.errors.length} error(s):\n` + data.errors.map(e => `• ${e.id}: ${e.error}`).join('\n');
            }
            btn.innerHTML = `<i class="fas fa-check"></i> Done (${data.generated})`;
            alert(msg);
            setTimeout(() => location.reload(), 500);
        } else {
            alert('Error regenerating cards.');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-redo"></i> Regenerate All';
        }
    })
    .catch(err => {
        alert(err.message || ('Request failed: ' + err));
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-redo"></i> Regenerate All';
    });
}

// ---- Regen All Missing ----
function regenMissing() {
    const missing = [...document.querySelectorAll('.card-wrapper[data-has-card="0"]')];
    if (!missing.length) { alert('No missing cards — all personnel already have ID cards!'); return; }
    if (!confirm(`Generate ID cards for ${missing.length} personnel without cards?\n\nThis will run on the server and may take a moment.`)) return;

    const btn = document.getElementById('btn-regen-missing');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating on server…';

    fetch(GEN_MISSING_URL, {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF_TOKEN }
    })
    .then(r => {
        const ct = r.headers.get('Content-Type') || '';
        if (!ct.includes('application/json')) {
            return r.text().then(t => {
                throw new Error(
                    'Server returned HTTP ' + r.status + ' instead of JSON.\n' +
                    'Make sure the server has the latest code (git pull + restart).'
                );
            });
        }
        return r.json();
    })
    .then(data => {
        if (data.success) {
            let msg = `Done — ${data.generated} generated, ${data.skipped} already existed.`;
            if (data.errors && data.errors.length) {
                msg += `\n\n${data.errors.length} error(s):\n`
                     + data.errors.map(e => `• ${e.id}: ${e.error}`).join('\n');
            }
            btn.innerHTML = `<i class="fas fa-check"></i> Done (${data.generated} generated)`;
            alert(msg);
            // Reload so all thumbnails and badges refresh from server
            setTimeout(() => location.reload(), 500);
        } else {
            alert('Error generating cards.');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> Generate Missing';
        }
    })
    .catch(err => {
        alert(err.message || ('Request failed: ' + err));
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Generate Missing';
    });
}
</script>
{% endblock %}
