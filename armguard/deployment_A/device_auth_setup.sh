#!/bin/bash

# =============================================================================\n# DEVICE AUTHORIZATION SYSTEM SETUP FUNCTIONS (V2.0 ENHANCEMENT)\n# =============================================================================\n# PURPOSE: Setup and verify device authorization system components\n# INTEGRATED: Device fingerprinting, Redis caching, production config validation\n# VERSION: 2.0.0 - Military-Grade Device Authorization\n# =============================================================================\n\nsetup_device_authorization_prerequisites() {\n    log_info \"Setting up Device Authorization System prerequisites...\"\n    \n    # Ensure Redis is available for device caching/lockout functionality\n    if ! command -v redis-cli >/dev/null 2>&1; then\n        log_error \"Redis is required for device authorization system\"\n        exit 1\n    fi\n    \n    # Test Redis connection\n    if ! redis-cli ping >/dev/null 2>&1; then\n        log_error \"Redis is not accessible - device authorization requires Redis for caching\"\n        exit 1\n    fi\n    \n    log_success \"Redis connection verified for device authorization\"\n    \n    # Check Python hashlib availability (for device fingerprinting)\n    if ! python3 -c \"import hashlib; print('OK')\" >/dev/null 2>&1; then\n        log_error \"Python hashlib module not available - required for device fingerprinting\"\n        exit 1\n    fi\n    \n    log_success \"Device Authorization System prerequisites verified\"\n}\n\nverify_device_authorization_integration() {\n    log_info \"Verifying Device Authorization System integration...\"\n    \n    # Define paths relative to script location\n    local armguard_root=\"$(dirname \"$SCRIPT_DIR\")\"\n    local middleware_file=\"$armguard_root/core/middleware/device_authorization.py\"\n    local auth_devices_file=\"$armguard_root/authorized_devices.json\"\n    \n    # Check if device authorization middleware files exist\n    if [ ! -f \"$middleware_file\" ]; then\n        log_error \"Device authorization middleware not found at: $middleware_file\"\n        log_info \"This indicates an incomplete ArmGuard installation\"\n        exit 1\n    fi\n    \n    log_success \"Device authorization middleware found\"\n    \n    # Check if authorized_devices.json exists\n    if [ -f \"$auth_devices_file\" ]; then\n        log_info \"Device authorization configuration file found\"\n        \n        # Verify JSON syntax\n        if python3 -c \"import json; json.load(open('$auth_devices_file'))\" 2>/dev/null; then\n            log_success \"Device authorization configuration JSON is valid\"\n            \n            # Check if it's production ready\n            local allow_all=$(python3 -c \"import json; config=json.load(open('$auth_devices_file')); print(config.get('allow_all', 'true'))\")\n            local security_mode=$(python3 -c \"import json; config=json.load(open('$auth_devices_file')); print(config.get('security_mode', 'DEVELOPMENT'))\")\n            \n            if [ \"$allow_all\" = \"False\" ] && [ \"$security_mode\" = \"PRODUCTION\" ]; then\n                log_success \"Device authorization configured for PRODUCTION deployment\"\n            else\n                log_warn \"Device authorization in DEVELOPMENT mode - will need production config\"\n            fi\n        else\n            log_error \"Invalid JSON in device authorization configuration\"\n            exit 1\n        fi\n    else\n        log_warn \"Device authorization configuration file not found - will be created during config phase\"\n    fi\n    \n    log_success \"Device Authorization System integration verified\"\n}\n\nconfigure_device_authorization_production() {\n    log_info \"Configuring Device Authorization for production deployment...\"\n    \n    local armguard_root=\"$(dirname \"$SCRIPT_DIR\")\"\n    local auth_devices_file=\"$armguard_root/authorized_devices.json\"\n    \n    # Create production device authorization configuration if it doesn't exist\n    if [ ! -f \"$auth_devices_file\" ]; then\n        log_info \"Creating production device authorization configuration...\"\n        \n        # Get network information\n        local server_ip=\"${SERVER_LAN_IP:-192.168.0.100}\"\n        local armory_ip=\"${ARMORY_PC_IP:-192.168.0.101}\"\n        \n        cat > \"$auth_devices_file\" << EOF\n{\n    \"devices\": [\n        {\n            \"name\": \"Server Terminal\",\n            \"hostname\": \"$(hostname)\",\n            \"ip\": \"$server_ip\",\n            \"mac\": \"00:00:00:00:00:00\",\n            \"can_transact\": true,\n            \"active\": true,\n            \"created_at\": \"$(date -Iseconds)\",\n            \"authorized_by\": \"deployment_script\",\n            \"description\": \"Server terminal for administrative operations\",\n            \"roles\": [\"admin\", \"server\"],\n            \"max_daily_transactions\": 500,\n            \"security_level\": \"HIGH\"\n        },\n        {\n            \"name\": \"Armory PC Terminal\",\n            \"hostname\": \"ARMORY-PC-001\",\n            \"ip\": \"$armory_ip\",\n            \"mac\": \"00:00:00:00:00:01\",\n            \"can_transact\": true,\n            \"active\": true,\n            \"created_at\": \"$(date -Iseconds)\",\n            \"authorized_by\": \"deployment_script\",\n            \"description\": \"Primary armory transaction terminal - Military operations\",\n            \"roles\": [\"armory\", \"transactions\"],\n            \"max_daily_transactions\": 200,\n            \"security_level\": \"MILITARY\",\n            \"authorized_users\": [\"armorer\", \"admin\"],\n            \"active_hours\": \"06:00-18:00\"\n        }\n    ],\n    \"allow_all\": false,\n    \"security_mode\": \"PRODUCTION\",\n    \"require_device_registration\": true,\n    \"max_failed_attempts\": 3,\n    \"lockout_duration_minutes\": 30,\n    \"restricted_paths\": [\n        \"/transactions/create/\",\n        \"/transactions/api/\",\n        \"/inventory/api/\",\n        \"/admin/transactions/\",\n        \"/admin/inventory/\",\n        \"/qr_manager/generate/\",\n        \"/personnel/api/create/\",\n        \"/admin/core/\",\n        \"/admin/users/\",\n        \"/api/\",\n        \"/core/api/\",\n        \"/inventory/api/delete/\",\n        \"/transactions/api/delete/\",\n        \"/users/api/\",\n        \"/personnel/api/delete/\"\n    ],\n    \"high_security_paths\": [\n        \"/admin/\",\n        \"/transactions/delete/\",\n        \"/users/delete/\",\n        \"/inventory/delete/\",\n        \"/admin/auth/\",\n        \"/personnel/delete/\",\n        \"/core/settings/\"\n    ],\n    \"audit_settings\": {\n        \"log_all_attempts\": true,\n        \"alert_on_unauthorized\": true,\n        \"retention_days\": 90\n    },\n    \"deployment_info\": {\n        \"deployed_at\": \"$(date -Iseconds)\",\n        \"deployment_version\": \"2.0.0\",\n        \"production_ready\": true,\n        \"deployed_by\": \"deployment_script\"\n    },\n    \"security_compliance\": {\n        \"nist_800_53\": true,\n        \"fisma_moderate\": true,\n        \"owasp_2021\": true,\n        \"military_standards\": true\n    }\n}\nEOF\n        \n        log_success \"Production device authorization configuration created\"\n    else\n        log_info \"Device authorization configuration exists - validating production settings...\"\n        \n        # Check current configuration\n        local current_allow_all=$(python3 -c \"import json; config=json.load(open('$auth_devices_file')); print(config.get('allow_all', 'true'))\")\n        local current_security_mode=$(python3 -c \"import json; config=json.load(open('$auth_devices_file')); print(config.get('security_mode', 'DEVELOPMENT'))\")\n        \n        if [ \"$current_allow_all\" != \"False\" ] || [ \"$current_security_mode\" != \"PRODUCTION\" ]; then\n            log_warn \"Current configuration is not production-ready\"\n            log_info \"Run 'python deploy_device_auth.py' to apply production settings\"\n        else\n            log_success \"Device authorization already configured for production\"\n        fi\n    fi\n    \n    # Set appropriate permissions\n    chmod 600 \"$auth_devices_file\"\n    log_success \"Device authorization configuration secured (600 permissions)\"\n}