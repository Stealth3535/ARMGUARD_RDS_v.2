#!/bin/bash\n\n# =============================================================================\n# DEVICE AUTHORIZATION CONFIGURATION FUNCTIONS FOR 02_CONFIG.SH\n# =============================================================================\n# PURPOSE: Configure device authorization system during deployment config phase\n# INTEGRATED: Production settings, network-specific device registration\n# VERSION: 2.0.0 - Military-Grade Device Authorization\n# =============================================================================\n\nconfigure_device_authorization() {\n    log_info \"Configuring Device Authorization System...\"\n    \n    # Source device authorization setup functions\n    if [ -f \"$SCRIPT_DIR/device_auth_setup.sh\" ]; then\n        source \"$SCRIPT_DIR/device_auth_setup.sh\"\n    fi\n    \n    # Configure for production deployment\n    configure_device_authorization_production\n    \n    # Update device IPs based on network configuration\n    update_device_authorization_network_settings\n    \n    log_success \"Device Authorization System configured successfully\"\n}\n\nupdate_device_authorization_network_settings() {\n    log_info \"Updating device authorization with network settings...\"\n    \n    local auth_devices_file=\"$ARMGUARD_ROOT/authorized_devices.json\"\n    \n    if [ ! -f \"$auth_devices_file\" ]; then\n        log_error \"Device authorization configuration file not found\"\n        return 1\n    fi\n    \n    # Create a Python script to update device IPs based on network configuration\n    cat > /tmp/update_device_ips.py << 'EOF'\nimport json\nimport sys\nimport os\n\ndef update_device_ips(config_file, server_ip, armory_ip, network_type):\n    with open(config_file, 'r') as f:\n        config = json.load(f)\n    \n    # Update device IPs based on network configuration\n    for device in config.get('devices', []):\n        if 'Server' in device.get('name', '') or device.get('hostname') == os.uname().nodename:\n            device['ip'] = server_ip\n            print(f\"Updated {device.get('name', 'Server')} IP to {server_ip}\")\n        elif 'Armory' in device.get('name', ''):\n            device['ip'] = armory_ip\n            print(f\"Updated {device.get('name', 'Armory PC')} IP to {armory_ip}\")\n    \n    # Update network-specific settings\n    config['deployment_info']['network_type'] = network_type\n    config['deployment_info']['server_ip'] = server_ip\n    config['deployment_info']['armory_ip'] = armory_ip\n    \n    # Save updated configuration\n    with open(config_file, 'w') as f:\n        json.dump(config, f, indent=4)\n    \n    print(f\"Device authorization updated for {network_type} network\")\n\nif __name__ == '__main__':\n    if len(sys.argv) != 5:\n        print(\"Usage: python update_device_ips.py <config_file> <server_ip> <armory_ip> <network_type>\")\n        sys.exit(1)\n    \n    update_device_ips(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4])\nEOF\n    \n    # Run the IP update based on network configuration\n    case \"$NETWORK_TYPE\" in\n        \"lan\")\n            python3 /tmp/update_device_ips.py \"$auth_devices_file\" \"$SERVER_LAN_IP\" \"$ARMORY_PC_IP\" \"lan\"\n            log_success \"Device IPs updated for LAN network: Server=$SERVER_LAN_IP, Armory=$ARMORY_PC_IP\"\n            ;;\n        \"wan\")\n            # For WAN, use localhost/server IP and configure appropriately\n            local wan_server_ip=\"127.0.0.1\" # WAN deployments typically use localhost\n            python3 /tmp/update_device_ips.py \"$auth_devices_file\" \"$wan_server_ip\" \"192.168.0.101\" \"wan\"\n            log_success \"Device IPs updated for WAN network: Server=$wan_server_ip\"\n            ;;\n        \"hybrid\")\n            python3 /tmp/update_device_ips.py \"$auth_devices_file\" \"$SERVER_LAN_IP\" \"$ARMORY_PC_IP\" \"hybrid\"\n            log_success \"Device IPs updated for Hybrid network: LAN=$SERVER_LAN_IP, Armory=$ARMORY_PC_IP\"\n            ;;\n        *)\n            log_warn \"Unknown network type: $NETWORK_TYPE - using default IPs\"\n            ;;\n    esac\n    \n    # Cleanup temporary script\n    rm -f /tmp/update_device_ips.py\n    \n    log_success \"Device authorization network settings updated\"\n}\n\nconfigure_device_authorization_middleware() {\n    log_info \"Configuring device authorization middleware in Django settings...\"\n    \n    local settings_file=\"$ARMGUARD_ROOT/core/settings.py\"\n    local production_settings=\"$ARMGUARD_ROOT/core/settings_production.py\"\n    \n    # Verify middleware is registered in settings\n    if grep -q \"core.middleware.DeviceAuthorizationMiddleware\" \"$settings_file\" >/dev/null 2>&1; then\n        log_success \"Device authorization middleware already registered in settings.py\"\n    else\n        log_error \"Device authorization middleware not found in Django settings\"\n        log_info \"This indicates an incomplete ArmGuard installation\"\n        return 1\n    fi\n    \n    # Check production settings if they exist\n    if [ -f \"$production_settings\" ]; then\n        if ! grep -q \"Device Authorization\" \"$production_settings\" >/dev/null 2>&1; then\n            log_info \"Adding device authorization note to production settings...\"\n            \n            cat >> \"$production_settings\" << 'EOF'\n\n# =============================================================================\n# DEVICE AUTHORIZATION SYSTEM (V2.0)\n# =============================================================================\n# Device authorization is configured via authorized_devices.json\n# Middleware: core.middleware.DeviceAuthorizationMiddleware\n# Security Mode: PRODUCTION (enforced via authorized_devices.json)\n# =============================================================================\nEOF\n            log_success \"Device authorization documentation added to production settings\"\n        fi\n    fi\n    \n    log_success \"Device authorization middleware configuration verified\"\n}\n\nvalidate_device_authorization_deployment() {\n    log_info \"Validating device authorization deployment configuration...\"\n    \n    local auth_devices_file=\"$ARMGUARD_ROOT/authorized_devices.json\"\n    \n    if [ ! -f \"$auth_devices_file\" ]; then\n        log_error \"Device authorization configuration file not found\"\n        return 1\n    fi\n    \n    # Run validation using Python\n    cat > /tmp/validate_device_auth.py << 'EOF'\nimport json\nimport sys\n\ndef validate_config(config_file):\n    try:\n        with open(config_file, 'r') as f:\n            config = json.load(f)\n        \n        # Validation checks\n        issues = []\n        warnings = []\n        \n        # Critical security checks\n        if config.get('allow_all', True) is not False:\n            issues.append(\"allow_all must be false for production\")\n        \n        if config.get('security_mode') != 'PRODUCTION':\n            issues.append(\"security_mode must be PRODUCTION\")\n        \n        if not config.get('require_device_registration'):\n            warnings.append(\"require_device_registration should be true\")\n        \n        # Device configuration checks\n        devices = config.get('devices', [])\n        if len(devices) < 2:\n            warnings.append(\"At least 2 devices should be configured\")\n        \n        transaction_devices = sum(1 for d in devices if d.get('can_transact'))\n        if transaction_devices < 1:\n            issues.append(\"At least one device must be able to transact\")\n        \n        # Path protection checks\n        restricted_paths = config.get('restricted_paths', [])\n        if len(restricted_paths) < 10:\n            warnings.append(\"Consider adding more restricted paths for security\")\n        \n        high_security_paths = config.get('high_security_paths', [])\n        if len(high_security_paths) < 5:\n            warnings.append(\"Consider adding more high-security paths\")\n        \n        # Audit settings\n        audit_settings = config.get('audit_settings', {})\n        if not audit_settings.get('log_all_attempts'):\n            warnings.append(\"audit logging should be enabled\")\n        \n        # Report results\n        if issues:\n            print(\"CRITICAL ISSUES FOUND:\")\n            for issue in issues:\n                print(f\"  ❌ {issue}\")\n        \n        if warnings:\n            print(\"WARNINGS:\")\n            for warning in warnings:\n                print(f\"  ⚠️ {warning}\")\n        \n        if not issues and not warnings:\n            print(\"✅ Device authorization configuration is production-ready\")\n        \n        return len(issues) == 0\n        \n    except json.JSONDecodeError as e:\n        print(f\"❌ Invalid JSON: {e}\")\n        return False\n    except Exception as e:\n        print(f\"❌ Validation error: {e}\")\n        return False\n\nif __name__ == '__main__':\n    if len(sys.argv) != 2:\n        print(\"Usage: python validate_device_auth.py <config_file>\")\n        sys.exit(1)\n    \n    if validate_config(sys.argv[1]):\n        sys.exit(0)\n    else:\n        sys.exit(1)\nEOF\n    \n    # Run validation\n    if python3 /tmp/validate_device_auth.py \"$auth_devices_file\"; then\n        log_success \"Device authorization configuration validation passed\"\n    else\n        log_warn \"Device authorization configuration has issues - review output above\"\n    fi\n    \n    # Cleanup\n    rm -f /tmp/validate_device_auth.py\n    \n    log_success \"Device authorization deployment validation completed\"\n}