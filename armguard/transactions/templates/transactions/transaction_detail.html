{% extends "base.html" %}

{% block title %}Transaction #{{ transaction.id }} - ArmGuard{% endblock %}

{% block content %}
<!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 350px; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}
    
    <div class="row">
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="page-title mb-0">Transaction #{{ transaction.id }}</h1>
                {% if user.is_superuser or user.groups.filter.name == 'Admin' or user.groups.filter.name == 'Armorer' %}
                <a href="{% url 'print_handler:download_transaction_pdf' transaction.id %}" class="btn btn-primary">
                    <i class="bi bi-download"></i> Download PDF Form
                </a>
                {% endif %}
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Transaction Details</h3>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 200px;">Date & Time:</th>
                            <td>{{ transaction.date_time|date:"F j, Y, H:i:s" }}</td>
                        </tr>
                        <tr>
                            <th>Action:</th>
                            <td>
                                {% if transaction.action == 'Take' %}
                                    <span class="badge badge-danger">WITHDRAW</span>
                                {% else %}
                                    <span class="badge badge-success">RETURN</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Personnel:</th>
                            <td>
                                <strong>{{ transaction.personnel.get_full_name }}</strong><br>
                                <small class="text-muted">
                                    {{ transaction.personnel.rank }}<br>
                                    Serial Number: {{ transaction.personnel.serial }}
                                </small>
                            </td>
                        </tr>
                        <tr>
                            <th>Item:</th>
                            <td>
                                <strong>{{ transaction.item.item_type }}</strong><br>
                                <small class="text-muted">
                                    Serial: {{ transaction.item.serial }}<br>
                                    Status at Transaction: {% if transaction.action == 'Take' %}Issued{% else %}Available{% endif %}<br>
                                    Current Status: {{ transaction.item.status }}<br>
                                    Current Condition: {{ transaction.item.condition }}
                                </small>
                            </td>
                        </tr>
                        {% if transaction.issued_by %}
                        <tr>
                            <th>Issued/Released By:</th>
                            <td>
                                {% if transaction.issued_by.personnel %}
                                    <strong>{{ transaction.issued_by.personnel.rank }} {{ transaction.issued_by.personnel.firstname }} {{ transaction.issued_by.personnel.surname }} {{ transaction.issued_by.personnel.serial }} PAF</strong>
                                {% else %}
                                    <strong>{{ transaction.issued_by.get_full_name|default:transaction.issued_by.username }}</strong>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% if transaction.duty_type %}
                        <tr>
                            <th>Duty Type:</th>
                            <td>{{ transaction.duty_type }}</td>
                        </tr>
                        {% endif %}
                        {% if transaction.mags %}
                        <tr>
                            <th>Magazines:</th>
                            <td>{{ transaction.mags }}</td>
                        </tr>
                        {% endif %}
                        {% if transaction.rounds %}
                        <tr>
                            <th>Rounds:</th>
                            <td>{{ transaction.rounds }}</td>
                        </tr>
                        {% endif %}
                        {% if transaction.notes %}
                        <tr>
                            <th>Notes:</th>
                            <td>{{ transaction.notes }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <div class="mb-3">
                <a href="{% url 'transactions:list' %}" class="btn btn-secondary">‚Üê Back to Transactions</a>
            </div>
        </div>
    </div>

<script>
// Auto-dismiss Django messages after 10 seconds
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 10000);
    });
});
</script>

<style>
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock %}
