{% extends "base.html" %}

{% block title %}Transactions - ArmGuard{% endblock %}

{% block global_messages %}{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        margin-bottom: 1.2rem;
        display: block;
        width: 100%;
    }
    
    .page-title {
        font-size: 2rem;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }
    
    .page-subtitle {
        color: #7f8c8d;
        font-size: 1rem;
    }

    .tx-dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 1rem;
        margin-top: 1rem;
        width: 100%;
    }

    @media (max-width: 1200px) {
        .tx-dashboard-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    @media (max-width: 768px) {
        .tx-dashboard-grid {
            grid-template-columns: 1fr;
        }
    }

    .tx-stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 0.95rem 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-top: 4px solid #cbd5e1;
    }

    .tx-stat-card.available { border-top-color: #10b981; }
    .tx-stat-card.issued { border-top-color: #f59e0b; }
    .tx-stat-card.total { border-top-color: #667eea; }
    .tx-stat-card.defcon { border-top-color: #dc2626; }
    .tx-stat-card.normal { border-top-color: #2563eb; }

    .tx-stat-title {
        font-size: 0.82rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6b7280;
        font-weight: 700;
        margin-bottom: 0;
    }

    .tx-stat-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        margin-bottom: 0.2rem;
    }

    .tx-stat-value {
        font-size: 2rem;
        line-height: 1;
        font-weight: 800;
        color: var(--stat-color, #111827);
        margin-bottom: 0;
    }

    .tx-stat-card.available { --stat-color: #10b981; }
    .tx-stat-card.issued { --stat-color: #f59e0b; }
    .tx-stat-card.total { --stat-color: #667eea; }
    .tx-stat-card.defcon { --stat-color: #dc2626; }
    .tx-stat-card.normal { --stat-color: #2563eb; }

    .tx-stat-note {
        font-size: 0.88rem;
        color: #059669;
        margin-bottom: 0.25rem;
    }

    .tx-stat-breakdown,
    .tx-mode-breakdown {
        font-size: 0.88rem;
        color: #374151;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.1rem 0.5rem;
    }

    .tx-stat-breakdown div,
    .tx-mode-breakdown div {
        display: flex;
        justify-content: space-between;
        align-items: center;
        line-height: 1.2;
    }

    .tx-summary-actions {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .tx-summary-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        padding: 0.35rem 0.65rem;
        border-radius: 999px;
        text-decoration: none;
        border: 1px solid transparent;
    }

    .tx-summary-btn.defcon {
        color: #b91c1c;
        background: #fee2e2;
        border-color: #fecaca;
    }

    .tx-summary-btn.normal {
        color: #1e40af;
        background: #dbeafe;
        border-color: #bfdbfe;
    }
    
    .view-selector {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .view-selector label {
        font-weight: 600;
        color: #2c3e50;
    }

    .view-selector select {
        padding: 0.5rem 1rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        min-width: 200px;
        cursor: pointer;
    }

    .view-selector select:focus {
        outline: none;
        border-color: #2c5f2d;
    }
    
    .search-bar {
        margin-bottom: 20px;
    }
    
    .search-input {
        width: 100%;
        padding: 12px 20px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s;
    }
    
    .search-input:focus {
        border-color: #2c5f2d;
        outline: none;
        box-shadow: 0 0 0 3px rgba(44, 95, 45, 0.1);
    }
    
    .filter-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 2rem;
    }
    
    .form-group {
        flex: 1;
    }
    
    .mode-action-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .transaction-form {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 15px;
        margin-bottom: 20px;
        align-items: start;
    }
    
    .form-row label {
        font-weight: 600;
        padding-top: 10px;
    }
    
    .info-text {
        margin-top: 8px;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        display: none;
    }
    
    .info-text.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .info-text.warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .info-text.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .scan-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 20px 0;
    }
    
    .btn-submit-transaction {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        font-weight: bold;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .btn-submit-transaction:hover {
        background: #218838;
    }

    body.defcon-lock {
        overflow: hidden;
        height: 100vh;
    }

    .container.defcon-lock {
        height: calc(100vh - 72px);
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 2rem;
        -webkit-overflow-scrolling: touch;
    }

    body.defcon-lock footer,
    body.defcon-lock .footer {
        display: none !important;
    }

    .container.defcon-lock .page-header,
    .container.defcon-lock .issued-items-section,
    .container.defcon-lock .transaction-history,
    .container.defcon-lock .view-selector,
    .container.defcon-lock .search-bar,
    .container.defcon-lock .filter-bar {
        display: none !important;
    }

    .container.defcon-lock .page-header {
        display: block !important;
        margin-bottom: 0.75rem;
    }

    .container.defcon-lock .tx-dashboard-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    .container.defcon-lock .tx-stat-card {
        padding: 0.95rem 1rem;
        border-radius: 12px;
    }

    .container.defcon-lock .tx-stat-title {
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }

    .container.defcon-lock .tx-stat-value {
        font-size: 2rem;
        margin-bottom: 0.2rem;
    }

    .container.defcon-lock .tx-stat-note,
    .container.defcon-lock .tx-stat-breakdown,
    .container.defcon-lock .tx-mode-breakdown {
        font-size: 0.9rem;
    }

    .container.defcon-lock .mode-action-row {
        position: sticky;
        top: 0;
        z-index: 20;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
    }

    .container.defcon-lock .transaction-form {
        margin-bottom: 0;
        padding: 1.1rem 1.2rem;
        border-radius: 10px;
    }

    .container.defcon-lock .transaction-form h3 {
        margin-bottom: 0.85rem;
        font-size: 1.25rem;
    }

    .container.defcon-lock .form-row {
        grid-template-columns: 170px 1fr;
        gap: 12px;
        margin-bottom: 14px;
    }

    .container.defcon-lock .form-row label {
        padding-top: 7px;
    }

    .container.defcon-lock #notes {
        min-height: 70px;
    }

    @media (max-width: 1200px) {
        .container.defcon-lock .tx-dashboard-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    @media (max-width: 768px) {
        .container.defcon-lock {
            height: calc(100vh - 64px);
            padding-bottom: 1rem;
        }

        .container.defcon-lock .tx-dashboard-grid {
            grid-template-columns: 1fr;
        }

        .container.defcon-lock .mode-action-row {
            grid-template-columns: 1fr;
        }

        .container.defcon-lock .form-row {
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .container.defcon-lock .form-row label {
            padding-top: 0;
        }
    }
    
    .issued-items-section, .transaction-history {
        margin-top: 40px;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 0.75rem;
    }

    .history-header h2 {
        margin: 0;
    }

    .history-pills {
        display: inline-flex;
        gap: 0.35rem;
        flex-wrap: wrap;
    }

    .history-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        padding: 0.3rem 0.75rem;
        font-size: 0.78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        border: 1px solid #d1d5db;
        color: #4b5563;
        background: #ffffff;
        text-decoration: none;
    }

    .history-pill.active {
        background: #111827;
        border-color: #111827;
        color: #ffffff;
    }
    
    .badge-issued {
        background: #dc3545;
        color: white;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .badge-available {
        background: #28a745;
        color: white;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    #qrScannerModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .scanner-content {
        background: #222;
        padding: 24px;
        border-radius: 8px;
        max-width: 400px;
        margin: auto;
        position: relative;
    }
    
    .scanner-content h3 {
        color: #fff;
        margin-bottom: 20px;
    }
    
    #qr-reader {
        width: 320px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- Messages -->
{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 350px; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
{% endif %}

<!-- Page Header -->
<div class="page-header">
    <span id="totalTransactionsCount" style="display:none;">{{ transaction_mode_counts.total_transactions }}</span>
    <div class="tx-dashboard-grid">
            <div class="tx-stat-card available">
                <div class="tx-stat-head">
                    <div class="tx-stat-title">Available Items</div>
                    <div class="tx-stat-value" id="availableItemsCount">{{ inventory_counts.available }}</div>
                </div>
                <div class="tx-stat-note">Ready for deployment</div>
                <div class="tx-stat-breakdown">
                    <div>M14: <strong id="availableTypeM14">{{ inventory_counts.by_status_type.Available.M14 }}</strong></div>
                    <div>M16: <strong id="availableTypeM16">{{ inventory_counts.by_status_type.Available.M16 }}</strong></div>
                    <div>M4: <strong id="availableTypeM4">{{ inventory_counts.by_status_type.Available.M4 }}</strong></div>
                    <div>Glock: <strong id="availableTypeGLOCK">{{ inventory_counts.by_status_type.Available.GLOCK }}</strong></div>
                    <div>.45: <strong id="availableTypeP45">{{ inventory_counts.by_status_type.Available.P45 }}</strong></div>
                </div>
            </div>

            <div class="tx-stat-card issued">
                <div class="tx-stat-head">
                    <div class="tx-stat-title">Currently Issued</div>
                    <div class="tx-stat-value" id="issuedItemsCount">{{ inventory_counts.issued }}</div>
                </div>
                <div class="tx-stat-note">In field operations</div>
                <div class="tx-stat-breakdown">
                    <div>M14: <strong id="issuedTypeM14">{{ inventory_counts.by_status_type.Issued.M14 }}</strong></div>
                    <div>M16: <strong id="issuedTypeM16">{{ inventory_counts.by_status_type.Issued.M16 }}</strong></div>
                    <div>M4: <strong id="issuedTypeM4">{{ inventory_counts.by_status_type.Issued.M4 }}</strong></div>
                    <div>Glock: <strong id="issuedTypeGLOCK">{{ inventory_counts.by_status_type.Issued.GLOCK }}</strong></div>
                    <div>.45: <strong id="issuedTypeP45">{{ inventory_counts.by_status_type.Issued.P45 }}</strong></div>
                </div>
            </div>

            <div class="tx-stat-card total">
                <div class="tx-stat-head">
                    <div class="tx-stat-title">Total Inventory</div>
                    <div class="tx-stat-value" id="totalInventoryCount">{{ inventory_counts.total }}</div>
                </div>
                <div class="tx-stat-note">Complete arsenal</div>
                <div class="tx-stat-breakdown">
                    <div>M14: <strong>{{ inventory_counts.by_status_type.Total.M14 }}</strong></div>
                    <div>M16: <strong>{{ inventory_counts.by_status_type.Total.M16 }}</strong></div>
                    <div>M4: <strong>{{ inventory_counts.by_status_type.Total.M4 }}</strong></div>
                    <div>Glock: <strong>{{ inventory_counts.by_status_type.Total.GLOCK }}</strong></div>
                    <div>.45: <strong>{{ inventory_counts.by_status_type.Total.P45 }}</strong></div>
                </div>
            </div>

            <div class="tx-stat-card defcon" id="modeTotalsCard">
                <div class="tx-stat-title">Mode Totals</div>
                <div class="tx-mode-breakdown">
                    <div><strong>DEFCON</strong></div>
                    <div></div>
                    <div>Released: <strong id="defconReleasedCount">{{ transaction_mode_counts.defcon_released }}</strong></div>
                    <div>Returned: <strong id="defconReturnedCount">{{ transaction_mode_counts.defcon_returned }}</strong></div>
                    <div style="margin-top: 0.35rem;"><strong>NORMAL</strong></div>
                    <div></div>
                    <div>Released: <strong id="normalReleasedCount">{{ transaction_mode_counts.normal_released }}</strong></div>
                    <div>Returned: <strong id="normalReturnedCount">{{ transaction_mode_counts.normal_returned }}</strong></div>
                </div>
                <div class="tx-summary-actions">
                    <a href="{% url 'print_handler:print_transactions' %}?mode=defcon&range={{ selected_history }}" class="tx-summary-btn defcon" target="_blank" rel="noopener">
                        <i class="fas fa-print"></i> DEFCON Summary
                    </a>
                    <a href="{% url 'print_handler:print_transactions' %}?mode=normal&range={{ selected_history }}" class="tx-summary-btn normal" target="_blank" rel="noopener">
                        <i class="fas fa-print"></i> NORMAL Summary
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Mode and Action Selection -->
    <div class="mode-action-row">
        <select id="modeSelect" class="form-control">
            <option value="normal">Normal Mode</option>
            <option value="defcon">Defcon Mode</option>
        </select>
        <select id="actionSelect" class="form-control">
            <option value="withdraw">Withdraw Item</option>
            <option value="return">Return Item</option>
        </select>
    </div>

    <!-- Transaction Form (Inline) -->
    {% if can_create_transaction %}
    <div class="transaction-form">
        <h3>üìù Create Transaction</h3>
        <form id="transactionForm" onsubmit="return false;">
            {% csrf_token %}
            
            <!-- Personnel Input -->
            <div class="form-row">
                <label for="personnelInput">Personnel ID:</label>
                <div>
                    <input type="text" id="personnelInput" class="form-control" placeholder="Scan or enter Personnel ID" autocomplete="off">
                    <div id="personnelInfo" class="info-text"></div>
                </div>
            </div>

            <!-- Item Input -->
            <div class="form-row">
                <label for="itemInput">Item ID:</label>
                <div>
                    <input type="text" id="itemInput" class="form-control" placeholder="Scan or enter Item ID" autocomplete="off">
                    <div id="itemInfo" class="info-text"></div>
                </div>
            </div>

            <!-- Duty Type (Normal Mode Only) -->
            <div class="form-row" id="dutyTypeRow">
                <label for="dutyType">Duty Type:</label>
                <select id="dutyType" class="form-control">
                    <option value="">Select Duty Type</option>
                    <option value="Duty Sentinel">Duty Sentinel</option>
                    <option value="Duty Security">Duty Security</option>
                    <option value="Vigil">Vigil</option>
                    <option value="Guard Duty">Guard Duty</option>
                </select>
            </div>

            <!-- Mags -->
            <div class="form-row" id="magsRow">
                <label for="mags">Mags:</label>
                <input type="number" id="mags" class="form-control" placeholder="Number of mags" min="0">
            </div>

            <!-- Rounds -->
            <div class="form-row" id="roundsRow">
                <label for="rounds">Rounds of Ammo:</label>
                <input type="number" id="rounds" class="form-control" placeholder="Rounds of ammo" min="0">
            </div>

            <!-- Notes -->
            <div class="form-row">
                <label for="notes">Notes:</label>
                <textarea id="notes" class="form-control" placeholder="Optional notes..." rows="3"></textarea>
            </div>

            <!-- Scan Buttons -->
            <div class="scan-buttons">
                <button type="button" class="btn btn-secondary" onclick="openQrScanner('personnelInput')">üì∑ Scan Personnel</button>
                <button type="button" class="btn btn-secondary" onclick="openQrScanner('itemInput')">üì∑ Scan Item</button>
            </div>

            <!-- Submit Button -->
            <button type="button" class="btn-submit-transaction" onclick="handleManualSubmit()">‚úÖ Submit Transaction</button>
        </form>
    </div>
    {% else %}
    <div class="alert alert-info" style="padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; background-color: #d1ecf1; border: 1px solid #bee5eb;">
        <i class="fas fa-info-circle"></i>
        <strong>View-Only Access:</strong> You can view transactions but cannot create new ones. Only Armorers and Superusers can create transactions. Contact an armorer or superuser for transaction assistance.
    </div>
    {% endif %}

    <!-- QR Scanner Modal -->
    <div id="qrScannerModal">
        <div class="scanner-content">
            <h3>Scan QR Code</h3>
            <div id="qr-reader"></div>
            <button type="button" onclick="closeQrScanner()" class="btn btn-danger" style="margin-top:16px; width: 100%;">Close</button>
        </div>
    </div>

    <!-- View Selector -->
    <div class="view-selector" style="margin-top: 3rem;">
        <label for="viewSelector">üìä View Transactions By:</label>
        <select id="viewSelector" onchange="location.href=this.value;">
            <option value="{% url 'transactions:list' %}" selected>Personnel Transactions</option>
            <option value="{% url 'transactions:item_transactions' %}">Item Transactions</option>
        </select>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Search by personnel name, rank, or item...">
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="form-group" style="margin: 0; min-width: 200px;">
            <select id="actionFilter" class="form-control form-select">
                <option value="">All Actions</option>
                <option value="Take">Withdraw</option>
                <option value="Return">Return</option>
            </select>
        </div>
        <div class="form-group" style="margin: 0; min-width: 200px;">
            <select id="dutyFilterDropdown" class="form-control form-select">
                <option value="">All Duty Types</option>
                <option value="Duty Sentinel">Duty Sentinel</option>
                <option value="Duty Security">Duty Security</option>
                <option value="Vigil">Vigil</option>
                <option value="Guard Duty">Guard Duty</option>
                <option value="Patrol">Patrol</option>
                <option value="Training">Training</option>
            </select>
        </div>
    </div>

    <!-- Currently Issued Items -->
    <div class="issued-items-section">
        <h2>Currently Issued Items</h2>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Personnel</th>
                        <th>Item Type</th>
                        <th>Serial</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in issued_items %}
                    <tr>
                        <td>{{ transaction.date_time|date:"d/m/y H:i:s" }}</td>
                        <td>
                            {{ transaction.personnel.get_full_name }}<br>
                            <small class="text-muted">{{ transaction.personnel.rank }} | Serial: {{ transaction.personnel.serial|default:"N/A" }}</small>
                        </td>
                        <td>{{ transaction.item.item_type }}</td>
                        <td>{{ transaction.item.serial }}</td>
                        <td>{{ transaction.notes|truncatewords:15|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No items currently issued</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Transaction History -->
    <div class="transaction-history">
        <div class="history-header">
            <h2>Recent Transaction History</h2>
            <div class="history-pills">
                <a href="?history=day" class="history-pill {% if selected_history == 'day' %}active{% endif %}">Day</a>
                <a href="?history=week" class="history-pill {% if selected_history == 'week' %}active{% endif %}">Week</a>
                <a href="?history=month" class="history-pill {% if selected_history == 'month' %}active{% endif %}">Month</a>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Personnel</th>
                        <th>Item</th>
                        <th>Action</th>
                        <th>Date/Time</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in recent_transactions %}
                    <tr data-duty-type="{{ transaction.duty_type }}" data-item-type="{{ transaction.item.item_type }}">
                        <td><strong>#{{ transaction.id }}</strong></td>
                        <td>
                            {{ transaction.personnel.get_full_name }}<br>
                            <small class="text-muted">{{ transaction.personnel.rank }}</small>
                        </td>
                        <td>{{ transaction.item.item_type }} - {{ transaction.item.serial }}</td>
                        <td>
                            {% if transaction.action == 'Take' %}
                            <span class="badge-issued">Withdraw</span>
                            {% else %}
                            <span class="badge-available">Return</span>
                            {% endif %}
                        </td>
                        <td>{{ transaction.date_time|date:"d/m/y H:i:s" }}</td>
                        <td>{{ transaction.notes|truncatewords:10|default:"-" }}</td>
                        <td>
                            <a href="{% url 'transactions:detail' transaction.id %}" class="btn btn-primary btn-sm">View</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No transactions found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let currentQrTarget = null;

function openQrScanner(targetInputId) {
    currentQrTarget = targetInputId;
    document.getElementById('qrScannerModal').style.display = 'flex';
    if (window.qrScannerInstance) {
        window.qrScannerInstance.clear();
    }
    window.qrScannerInstance = new Html5Qrcode("qr-reader");
    window.qrScannerInstance.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
            console.log('QR Code scanned:', qrCodeMessage); // Debug log
            const input = document.getElementById(currentQrTarget);
            input.value = qrCodeMessage;
            console.log('Set value for input:', currentQrTarget, 'to:', qrCodeMessage); // Debug log
            closeQrScanner();
            // Trigger validation after a brief delay to ensure UI is updated
            setTimeout(() => {
                console.log('Triggering blur event for:', currentQrTarget); // Debug log
                input.dispatchEvent(new Event('blur'));

                // Auto-tab to next field when personnel input was scanned.
                if (currentQrTarget === 'personnelInput') {
                    itemInput.focus();
                    itemInput.select();
                } else if (currentQrTarget === 'itemInput') {
                    focusAfterItemScan();
                }
            }, 100);
        },
        errorMessage => {}
    ).catch(err => {
        alert('Camera error: ' + err);
        closeQrScanner();
    });
}

function closeQrScanner() {
    document.getElementById('qrScannerModal').style.display = 'none';
    if (window.qrScannerInstance) {
        window.qrScannerInstance.stop().then(() => window.qrScannerInstance.clear());
    }
}

// Mode selection handling
const modeSelect = document.getElementById('modeSelect');
const dutyTypeRow = document.getElementById('dutyTypeRow');
const magsRow = document.getElementById('magsRow');
const roundsRow = document.getElementById('roundsRow');
const actionSelect = document.getElementById('actionSelect');
const scanButtonsRow = document.querySelector('.scan-buttons');
const totalTransactionsCountElement = document.getElementById('totalTransactionsCount');
const availableItemsCountElement = document.getElementById('availableItemsCount');
const issuedItemsCountElement = document.getElementById('issuedItemsCount');
const defconReleasedCountElement = document.getElementById('defconReleasedCount');
const defconReturnedCountElement = document.getElementById('defconReturnedCount');
const normalReleasedCountElement = document.getElementById('normalReleasedCount');
const normalReturnedCountElement = document.getElementById('normalReturnedCount');

const itemTypeAliases = {
    M14: 'M14',
    M16: 'M16',
    M4: 'M4',
    GLOCK: 'GLOCK',
    45: 'P45'
};

const scannerCapture = {
    buffer: '',
    timer: null,
    lastKeyTime: 0,
    timeoutMs: 120
};
let hotkeySubmitting = false;
let personnelValidated = false;
let itemValidated = false;
let suppressPersonnelAutoTab = false;

function focusAfterItemScan() {
    const notesInput = document.getElementById('notes');
    if (notesInput) {
        notesInput.focus();
        return;
    }

    const submitButton = document.querySelector('.btn-submit-transaction');
    if (submitButton) {
        submitButton.focus();
    }
}

function trySubmitOnHotkey() {
    if (hotkeySubmitting) return;
    if (!personnelValidated || !itemValidated) return;

    hotkeySubmitting = true;
    submitTransaction().finally(() => {
        hotkeySubmitting = false;
    });
}

function incrementHeaderTransactionCount() {
    if (!totalTransactionsCountElement) return;
    const currentValue = parseInt(totalTransactionsCountElement.textContent, 10);
    if (Number.isNaN(currentValue)) return;
    totalTransactionsCountElement.textContent = String(currentValue + 1);
}

function adjustCountElement(element, delta) {
    if (!element) return;
    const currentValue = parseInt(element.textContent, 10);
    if (Number.isNaN(currentValue)) return;
    element.textContent = String(Math.max(0, currentValue + delta));
}

function updateElementById(id, delta) {
    const element = document.getElementById(id);
    adjustCountElement(element, delta);
}

function updateDashboardAfterSubmit(responseData, selectedMode) {
    incrementHeaderTransactionCount();

    const action = responseData?.action;
    const transactionMode = (selectedMode || 'normal').toLowerCase();
    const rawItemType = responseData?.transaction?.item?.type;
    const itemType = itemTypeAliases[rawItemType] || rawItemType;

    if (transactionMode === 'defcon') {
        if (action === 'Take') {
            adjustCountElement(defconReleasedCountElement, 1);
        } else if (action === 'Return') {
            adjustCountElement(defconReturnedCountElement, 1);
        }
    } else {
        if (action === 'Take') {
            adjustCountElement(normalReleasedCountElement, 1);
        } else if (action === 'Return') {
            adjustCountElement(normalReturnedCountElement, 1);
        }
    }

    if (action === 'Take') {
        adjustCountElement(availableItemsCountElement, -1);
        adjustCountElement(issuedItemsCountElement, 1);
        if (itemType) {
            updateElementById(`availableType${itemType}`, -1);
            updateElementById(`issuedType${itemType}`, 1);
        }
    } else if (action === 'Return') {
        adjustCountElement(availableItemsCountElement, 1);
        adjustCountElement(issuedItemsCountElement, -1);
        if (itemType) {
            updateElementById(`availableType${itemType}`, 1);
            updateElementById(`issuedType${itemType}`, -1);
        }
    }
}

function resetScannerBuffer() {
    scannerCapture.buffer = '';
    scannerCapture.lastKeyTime = 0;
    if (scannerCapture.timer) {
        clearTimeout(scannerCapture.timer);
        scannerCapture.timer = null;
    }
}

function parseScannedPayload(rawPayload) {
    const raw = (rawPayload || '').trim();
    if (!raw) return null;

    const upperRaw = raw.toUpperCase();

    if (upperRaw.startsWith('PERSONNEL:')) {
        const parts = raw.split(':');
        return { type: 'personnel', value: (parts[1] || '').trim() };
    }

    if (upperRaw.startsWith('ITEM:')) {
        const parts = raw.split(':');
        return { type: 'item', value: (parts[1] || '').trim() };
    }

    if (upperRaw.startsWith('PE-') || upperRaw.startsWith('PO-')) {
        return { type: 'personnel', value: raw };
    }

    if (upperRaw.startsWith('ITM-') || upperRaw.startsWith('I')) {
        return { type: 'item', value: raw };
    }

    return { type: 'unknown', value: raw };
}

function fillScannedField(parsedScan) {
    if (!parsedScan || !parsedScan.value) return;

    if (parsedScan.type === 'personnel') {
        const scannedWhileItemFocused = (
            (document.activeElement && document.activeElement.id === 'itemInput') ||
            currentQrTarget === 'itemInput'
        );

        if (scannedWhileItemFocused) {
            itemInput.value = '';
            itemValidated = false;
            itemInfo.style.display = 'none';
            suppressPersonnelAutoTab = true;
        }

        personnelInput.value = parsedScan.value;
        personnelInput.dispatchEvent(new Event('blur'));
        showNotification(`Scanned personnel ID: ${parsedScan.value}`, 'info');

        // Immediate tab behavior right after scan capture.
        setTimeout(() => {
            if (scannedWhileItemFocused) {
                personnelInput.focus();
                personnelInput.select();
            } else {
                itemInput.focus();
                itemInput.select();
            }
        }, 80);
        return;
    }

    if (parsedScan.type === 'item') {
        itemInput.value = parsedScan.value;
        itemInput.dispatchEvent(new Event('blur'));
        showNotification(`Scanned item ID: ${parsedScan.value}`, 'info');

        setTimeout(() => {
            focusAfterItemScan();
        }, 80);
    }
}

async function resolveAndFillUnknownScan(rawValue) {
    const encoded = encodeURIComponent(rawValue);

    try {
        const personnelResponse = await fetch(`/api/personnel/${encoded}/`);
        if (personnelResponse.ok) {
            fillScannedField({ type: 'personnel', value: rawValue });
            return;
        }
    } catch (error) {
        console.warn('Personnel lookup failed for unknown scan:', error);
    }

    try {
        const itemResponse = await fetch(`/api/items/${encoded}/`);
        if (itemResponse.ok) {
            fillScannedField({ type: 'item', value: rawValue });
            return;
        }
    } catch (error) {
        console.warn('Item lookup failed for unknown scan:', error);
    }

    showNotification(`Unrecognized scan payload: ${rawValue}`, 'error');
}

async function processScannerInput(rawPayload) {
    const parsed = parseScannedPayload(rawPayload);
    if (!parsed || !parsed.value) return;

    if (parsed.type === 'unknown') {
        await resolveAndFillUnknownScan(parsed.value);
        return;
    }

    fillScannedField(parsed);
}

function setDefconActionState() {
    const isDefconMode = modeSelect.value === 'defcon';
    const returnOption = actionSelect.querySelector('option[value="return"]');

    if (isDefconMode) {
        actionSelect.value = 'withdraw';
        actionSelect.disabled = true;
        if (scanButtonsRow) {
            scanButtonsRow.style.display = 'none';
        }
        if (returnOption) {
            returnOption.disabled = true;
            returnOption.hidden = true;
        }
    } else {
        actionSelect.disabled = false;
        if (scanButtonsRow) {
            scanButtonsRow.style.display = 'grid';
        }
        if (returnOption) {
            returnOption.disabled = false;
            returnOption.hidden = false;
        }
    }
}

function setDefconLockLayout() {
    const isDefconMode = modeSelect.value === 'defcon';
    const mainContainer = document.querySelector('.container');

    if (isDefconMode) {
        document.body.classList.add('defcon-lock');
        if (mainContainer) {
            mainContainer.classList.add('defcon-lock');
        }
    } else {
        document.body.classList.remove('defcon-lock');
        if (mainContainer) {
            mainContainer.classList.remove('defcon-lock');
        }
    }
}

function applyTransactionMode(mode, persist = true) {
    modeSelect.value = mode;

    if (persist) {
        localStorage.setItem('transactions_mode', mode);
        if (mode === 'defcon') {
            localStorage.setItem('transactions_defcon_lock', '1');
        } else {
            localStorage.removeItem('transactions_defcon_lock');
        }
    }

    if (mode === 'defcon') {
        dutyTypeRow.style.display = 'none';
        magsRow.style.display = 'none';
        roundsRow.style.display = 'none';
    } else {
        dutyTypeRow.style.display = 'grid';
        magsRow.style.display = 'grid';
        roundsRow.style.display = 'grid';
    }

    setDefconActionState();
    setDefconLockLayout();
}

modeSelect.addEventListener('change', function() {
    applyTransactionMode(this.value, true);
});

const defconLockFlag = localStorage.getItem('transactions_defcon_lock') === '1';
const savedMode = localStorage.getItem('transactions_mode');
if (defconLockFlag) {
    applyTransactionMode('defcon', false);
} else if (savedMode === 'normal' || savedMode === 'defcon') {
    applyTransactionMode(savedMode, false);
} else {
    applyTransactionMode(modeSelect.value, false);
}

document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.altKey || e.metaKey) return;

    if (e.key === 'Enter' || e.key === 'Tab') {
        if (scannerCapture.buffer.length >= 4) {
            e.preventDefault();
            const payload = scannerCapture.buffer;
            resetScannerBuffer();
            processScannerInput(payload).then(() => {
                trySubmitOnHotkey();
            });
        } else {
            e.preventDefault();
            resetScannerBuffer();
            trySubmitOnHotkey();
        }
        return;
    }

    if (e.key.length !== 1) return;

    const now = Date.now();
    if (scannerCapture.lastKeyTime && (now - scannerCapture.lastKeyTime) > scannerCapture.timeoutMs) {
        scannerCapture.buffer = '';
    }

    scannerCapture.buffer += e.key;
    scannerCapture.lastKeyTime = now;

    if (scannerCapture.timer) {
        clearTimeout(scannerCapture.timer);
    }

    scannerCapture.timer = setTimeout(() => {
        resetScannerBuffer();
    }, scannerCapture.timeoutMs);
});

// Personnel validation
const personnelInput = document.getElementById('personnelInput');
const personnelInfo = document.getElementById('personnelInfo');

personnelInput.addEventListener('blur', async function() {
    const personnelId = this.value.trim();
    if (!personnelId) {
        personnelValidated = false;
        personnelInfo.style.display = 'none';
        return;
    }

    try {
        const response = await fetch(`/api/personnel/${personnelId}/`);
        if (response.ok) {
            const data = await response.json();

            if (data.has_issued_firearm) {
                personnelValidated = false;
                personnelInfo.className = 'info-text error';
                personnelInfo.textContent = '‚úó Personnel already has an issued firearm';
                personnelInfo.style.display = 'block';
                showNotification('Personnel already has and issued firearm', 'error');
                return;
            }

            personnelValidated = true;
            personnelInfo.className = 'info-text success';
            personnelInfo.textContent = `‚úì ${data.firstname} ${data.middle_initial ? data.middle_initial + '.' : ''} ${data.surname} - ${data.rank}`;
            personnelInfo.style.display = 'block';
            
            // Show automatic notification for successful personnel scan
            showNotification(`Personnel scanned: ${data.firstname} ${data.surname} - ${data.rank}`, 'success');

            // Move directly to Item ID input after successful personnel validation
            if (suppressPersonnelAutoTab) {
                suppressPersonnelAutoTab = false;
                personnelInput.focus();
                personnelInput.select();
            } else {
                itemInput.focus();
                itemInput.select();
            }
        } else {
            personnelValidated = false;
            personnelInfo.className = 'info-text error';
            personnelInfo.textContent = '‚úó Personnel not found';
            personnelInfo.style.display = 'block';
        }
    } catch (error) {
        personnelValidated = false;
        personnelInfo.className = 'info-text error';
        personnelInfo.textContent = '‚úó Error validating personnel';
        personnelInfo.style.display = 'block';
    }
});

// Item validation
const itemInput = document.getElementById('itemInput');
const itemInfo = document.getElementById('itemInfo');

itemInput.addEventListener('blur', async function() {
    const itemId = this.value.trim();
    console.log('Item validation triggered for:', itemId); // Debug log
    if (!itemId) {
        itemValidated = false;
        itemInfo.style.display = 'none';
        return;
    }

    try {
        // Include duty type in request for autofill suggestions
        const dutyType = document.getElementById('dutyType').value;
        const url = `/api/items/${itemId}/${dutyType ? '?duty_type=' + encodeURIComponent(dutyType) : ''}`;
        const response = await fetch(url);
        console.log('API Response status:', response.status, 'for URL:', url); // Debug log
        if (response.ok) {
            const data = await response.json();
            console.log('API Response data:', data); // Debug log
            const action = actionSelect.value;
            const mode = modeSelect.value;
            itemValidated = true;
            
            // Always show item info first
            itemInfo.className = 'info-text success';
            itemInfo.textContent = `‚úì ${data.item_type} - Serial: ${data.serial} - Status: ${data.status}`;
            
            // Check action compatibility and suggest if needed
            let actionWarning = '';
            if (mode === 'defcon') {
                if (data.status !== 'Available') {
                    actionWarning = ` ‚ö† Defcon mode allows withdrawal only. Item must be Available.`;
                    itemValidated = false;
                }
            } else if (action === 'withdraw' && data.status !== 'Available') {
                actionWarning = ` ‚ö† Item not available for withdrawal`;
            } else if (action === 'return' && data.status !== 'Issued') {
                actionWarning = ` ‚ö† Item not issued - should withdraw instead`;
                // Auto-suggest correct action
                actionSelect.value = 'withdraw';
            } else if (action === 'withdraw' && data.status === 'Issued') {
                actionWarning = ` ‚ö† Item already issued - should return instead`;
                // Auto-suggest correct action  
                actionSelect.value = 'return';
            }
            
            if (actionWarning) {
                itemInfo.textContent += actionWarning;
                itemInfo.className = 'info-text warning';
            }
            
            // Auto-fill mags and rounds regardless of action compatibility
            if (data.autofill) {
                if (data.autofill.mags > 0) {
                    document.getElementById('mags').value = data.autofill.mags;
                }
                if (data.autofill.rounds > 0) {
                    document.getElementById('rounds').value = data.autofill.rounds;
                }
            }
            
            itemInfo.style.display = 'block';
        } else {
            itemValidated = false;
            itemInfo.className = 'info-text error';
            itemInfo.textContent = '‚úó Item not found';
            itemInfo.style.display = 'block';
        }
    } catch (error) {
        itemValidated = false;
        itemInfo.className = 'info-text error';
        itemInfo.textContent = '‚úó Error validating item';
        itemInfo.style.display = 'block';
    }
});

personnelInput.addEventListener('input', function() {
    personnelValidated = false;
});

itemInput.addEventListener('input', function() {
    itemValidated = false;
});

// Prevent any automatic form submission
document.getElementById('transactionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    console.log('Automatic form submission prevented');
    return false;
});

// Add Enter key prevention for all form inputs
document.querySelectorAll('#transactionForm input, #transactionForm select, #transactionForm textarea').forEach(element => {
    element.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            console.log('Enter key submission prevented');
            return false;
        }
    });
});

// Manual submit handler - only called when button is clicked
function handleManualSubmit() {
    const mode = document.getElementById('modeSelect').value;
    console.log('Manual submit triggered in mode:', mode);
    
    // In normal mode, always require explicit user action
    if (mode === 'normal') {
        submitTransaction();
    } else if (mode === 'defcon') {
        // Defcon mode might have different behavior in the future
        submitTransaction();
    }
}

// Actual transaction submission function
async function submitTransaction() {
    console.log('Submitting transaction...'); // Debug log
    
    // Get form values
    const personnelId = document.getElementById('personnelInput').value.trim();
    const itemId = document.getElementById('itemInput').value.trim();
    const action = document.getElementById('actionSelect').value;
    const mode = document.getElementById('modeSelect').value;
    const notes = document.getElementById('notes').value.trim();
    const dutyType = document.getElementById('dutyType').value;
    const mags = document.getElementById('mags').value;
    const rounds = document.getElementById('rounds').value;

    // Validate required fields - show inline error instead of popup
    if (!personnelId || !itemId) {
        // Show inline error message instead of popup
        let errorDiv = document.getElementById('form-error');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'form-error';
            errorDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 10px; border: 1px solid #f5c6cb; border-radius: 4px; margin: 10px 0;';
            document.getElementById('transactionForm').insertBefore(errorDiv, document.querySelector('.btn-submit-transaction'));
        }
        errorDiv.textContent = 'Please enter both Personnel ID and Item ID before submitting.';
        errorDiv.style.display = 'block';
        
        // Hide error after 5 seconds
        setTimeout(() => {
            if (errorDiv) errorDiv.style.display = 'none';
        }, 5000);
        
        return;
    }
    
    // Hide any existing error
    const existingErrorDiv = document.getElementById('form-error');
    if (existingErrorDiv) existingErrorDiv.style.display = 'none';

    try {
        const response = await fetch('/api/transactions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                personnel_id: personnelId,
                item_id: itemId,
                action: mode === 'defcon' ? 'Take' : (action === 'withdraw' ? 'Take' : 'Return'),
                mode: mode,
                notes: notes,
                mags: mags || 0,
                rounds: rounds || 0,
                duty_type: dutyType
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Transaction response:', data); // Debug log
            showNotification('‚úì Transaction #' + data.transaction_id + ' completed successfully!', 'success');
            updateDashboardAfterSubmit(data, mode);

            const prepareNextDefconTransaction = () => {
                itemInput.value = '';
                itemValidated = false;
                itemInfo.style.display = 'none';
                document.getElementById('notes').value = '';
                document.getElementById('mags').value = '';
                document.getElementById('rounds').value = '';
                itemInput.focus();
            };
            
            // Auto-print PDF for withdrawals (Take)
            // Temporarily disabled in DEFCON mode.
            if (mode !== 'defcon' && data.action === 'Take' && data.transaction_id) {
                console.log('üñ®Ô∏è Auto-print triggered for transaction', data.transaction_id);
                
                // Validate transaction ID before proceeding
                if (!data.transaction_id || data.transaction_id === 'undefined' || data.transaction_id === 'null') {
                    console.error('‚ùå Invalid transaction_id:', data.transaction_id);
                    showNotification('‚ö†Ô∏è Print failed: Invalid transaction ID', 'error');
                    return;
                }
                
                // Show printing notification
                showNotification('üìÑ Opening print dialog for transaction receipt...', 'info');
                
                // Construct and validate PDF URL
                const pdfUrl = `/print/transaction/${data.transaction_id}/pdf/`;
                console.log('üîç PDF URL for print:', pdfUrl);
                console.log('üîç Transaction data:', JSON.stringify(data, null, 2));
                
                // Open PDF directly in a new window and print only after navigation completes
                let printWindow;
                try {
                    printWindow = window.open(pdfUrl, 'PrintWindow', 'width=900,height=800,scrollbars=yes,resizable=yes');
                    console.log('üîç Print window opened:', printWindow ? 'SUCCESS' : 'FAILED (pop-up blocked)');
                } catch (openError) {
                    console.error('‚ùå Failed to open print window:', openError);
                    showNotification('‚ùå Failed to open print window: ' + openError.message, 'error');
                    return;
                }
                
                if (!printWindow) {
                    console.error('‚ùå Print window blocked by pop-up blocker!');
                    showNotification('‚ö†Ô∏è Pop-up blocked! Please allow pop-ups to auto-print receipts.', 'error');
                    
                    // Enhanced fallback with URL validation
                    const fallbackMsg = document.createElement('div');
                    fallbackMsg.style.cssText = 'background: #fff3cd; color: #856404; padding: 15px; margin: 10px 0; border: 1px solid #ffeaa7; border-radius: 8px; text-align: center;';
                    fallbackMsg.innerHTML = `
                        <strong>‚ö†Ô∏è Please allow pop-ups for auto-print</strong><br>
                        <p>Transaction ID: ${data.transaction_id}</p>
                        <p>PDF URL: ${pdfUrl}</p>
                        <a href="${pdfUrl}" target="_blank" style="color: #004085; text-decoration: underline; font-weight: bold;">
                            Click here to open and print the receipt manually
                        </a>
                    `;
                    document.getElementById('transactionForm').insertBefore(fallbackMsg, document.getElementById('transactionForm').firstChild);
                } else {
                    let printSent = false;
                    let attempts = 0;
                    const maxAttempts = 20; // 10 seconds total

                    const triggerPrint = (label) => {
                        if (printSent) return;
                        try {
                            if (printWindow && !printWindow.closed) {
                                console.log(`üñ®Ô∏è Triggering print (${label})...`);
                                printWindow.focus();
                                printWindow.print();
                                printSent = true;
                            }
                        } catch (e) {
                            console.warn(`Print attempt failed (${label}):`, e);
                        }
                    };

                    // Wait until popup leaves about:blank before printing.
                    const waitForPdf = setInterval(() => {
                        attempts += 1;
                        try {
                            const currentUrl = printWindow.location.href || '';
                            if (currentUrl && !currentUrl.includes('about:blank')) {
                                clearInterval(waitForPdf);
                                setTimeout(() => triggerPrint('pdf_ready'), 1200);
                                return;
                            }
                        } catch (e) {
                            // Ignore transient access errors while browser is navigating.
                        }

                        if (attempts >= maxAttempts) {
                            clearInterval(waitForPdf);
                            showNotification('‚ö†Ô∏è Auto-print delayed. Use Ctrl+P in the opened PDF window.', 'warning');
                        }
                    }, 500);
                }
                
                if (mode === 'defcon') {
                    prepareNextDefconTransaction();
                } else {
                    // Reload transaction list after printing
                    setTimeout(() => {
                        console.log('‚Üª Reloading transaction list...');
                        location.reload();
                    }, 12000);
                }
            } else {
                if (mode === 'defcon') {
                    prepareNextDefconTransaction();
                } else {
                    // For Return transactions, reload after short delay
                    console.log('Return transaction completed, reloading...');
                    setTimeout(() => location.reload(), 1200);
                }
            }
        } else {
            const error = await response.json();
            showNotification('Transaction failed: ' + (error.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showNotification('Transaction failed: ' + error.message, 'error');
    }
}

// Filter functionality for transaction tables
const searchInput = document.getElementById('searchInput');
const actionFilter = document.getElementById('actionFilter');
const dutyFilterDropdown = document.getElementById('dutyFilterDropdown');
const itemTypeFilter = document.getElementById('itemTypeFilter');

function filterTransactions() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedAction = actionFilter.value;
    const selectedDuty = dutyFilterDropdown.value;
    const selectedItemType = itemTypeFilter.value;
    
    const rows = document.querySelectorAll('.transaction-history tbody tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 0) return; // Skip empty rows
        
        // Get row data
        const personnel = cells[1]?.textContent.toLowerCase() || '';
        const item = cells[2]?.textContent.toLowerCase() || '';
        const action = cells[3]?.textContent.trim();
        const notes = cells[5]?.textContent.toLowerCase() || '';
        
        // Extract duty type and item type from row
        const dutyType = row.dataset.dutyType || '';
        const itemType = row.dataset.itemType || '';
        
        // Search match
        const searchMatch = !searchTerm || 
            personnel.includes(searchTerm) || 
            item.includes(searchTerm) || 
            notes.includes(searchTerm);
        
        // Action match
        const actionMatch = !selectedAction || 
            (selectedAction === 'Take' && action.includes('Withdraw')) ||
            (selectedAction === 'Return' && action.includes('Return'));
        
        // Duty type match
        const dutyMatch = !selectedDuty || dutyType === selectedDuty;
        
        // Item type match
        const itemTypeMatch = !selectedItemType || itemType.includes(selectedItemType);
        
        // Show/hide row
        if (searchMatch && actionMatch && dutyMatch && itemTypeMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

searchInput.addEventListener('input', filterTransactions);
actionFilter.addEventListener('change', filterTransactions);
dutyFilterDropdown.addEventListener('change', filterTransactions);
itemTypeFilter.addEventListener('change', filterTransactions);

// Notification system
function showNotification(message, type = 'info') {
    // Keep one info toast at a time to avoid stacked/staggering notifications.
    if (type === 'info') {
        document.querySelectorAll('.js-toast-info').forEach(el => el.remove());
    }

    // Create notification element
    const notification = document.createElement('div');
    notification.classList.add(`js-toast-${type}`);
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    // Set background color based on type
    if (type === 'success') {
        notification.style.background = '#28a745';
    } else if (type === 'error') {
        notification.style.background = '#dc3545';
    } else if (type === 'info') {
        notification.style.background = '#17a2b8';  // Teal/cyan for info
    } else {
        notification.style.background = '#007bff';  // Default blue
    }
    
    notification.textContent = message;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Auto-dismiss Django messages after 10 seconds
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 10000);
    });
});
</script>

<style>
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock %}
