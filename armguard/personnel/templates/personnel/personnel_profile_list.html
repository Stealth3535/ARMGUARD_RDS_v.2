{% extends 'base.html' %}
{% load static %}

{% block title %}Personnel Directory - ArmGuard{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .page-header h1 {
        margin: 0;
        color: #333;
        font-size: 2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary {
        padding: 0.75rem 1.5rem;
        background: #667eea;
        color: white;
        border-radius: 5px;
        text-decoration: none;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-secondary {
        padding: 0.5rem 1rem;
        background: #f3f4f6;
        color: #333;
        border-radius: 5px;
        text-decoration: none;
        border: 1px solid #d1d5db;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .btn-secondary:hover {
        background: #e5e7eb;
        border-color: #9ca3af;
    }
    
    /* Statistics Cards */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 0.95rem 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-top: 4px solid var(--card-color, #667eea);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .stat-card.officers { --card-color: #f59e0b; }
    .stat-card.enlisted { --card-color: #10b981; }
    .stat-card.active { --card-color: #059669; }
    .stat-card.total { --card-color: #667eea; }

    .stat-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        margin-bottom: 0.2rem;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1;
        color: var(--card-color, #111827);
        margin-bottom: 0;
    }
    
    .stat-label {
        font-size: 0.82rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 700;
        margin-bottom: 0;
    }
    
    /* Search and Filter Bar */
    .filter-bar {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .filter-row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .search-box {
        flex: 1;
        min-width: 250px;
    }
    
    .search-box input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 5px;
        font-size: 0.95rem;
        transition: all 0.2s;
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .filter-select {
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 5px;
        font-size: 0.95rem;
        background: white;
        cursor: pointer;
    }
    
    .quick-filters {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }
    
    .filter-chip {
        padding: 0.5rem 1rem;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .filter-chip:hover {
        background: #e5e7eb;
    }
    
    .filter-chip.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .personnel-table {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .table-title {
        font-weight: 600;
        color: #333;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .table-title h3 {
        margin: 0;
        font-size: 1.1rem;
    }
    
    .count-badge {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .table-wrapper {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th {
        background: #f8f9fa;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }
    
    th:hover {
        background: #e9ecef;
    }
    
    th.sortable::after {
        content: ' ‚áÖ';
        opacity: 0.3;
        font-size: 0.8em;
    }
    
    td {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    tr:hover {
        background: #f9fafb;
    }
    
    tr:last-child td {
        border-bottom: none;
    }
    
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .badge-officer {
        background: #fef3c7;
        color: #92400e;
    }
    
    .badge-enlisted {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .badge-superuser {
        background: #fee2e2;
        color: #7f1d1d;
    }
    
    .badge-active {
        background: #dcfce7;
        color: #14532d;
    }
    
    .badge-inactive {
        background: #f3f4f6;
        color: #6b7280;
    }
    
    .action-links {
        display: flex;
        gap: 1rem;
    }
    
    .action-links a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
    }
    
    .action-links a:hover {
        text-decoration: underline;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #666;
    }
    
    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    .personnel-picture {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e5e7eb;
    }
    
    @media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box {
            width: 100%;
        }
        
        .stats-container {
            grid-template-columns: 1fr;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="page-header">
        <h1><i class="fas fa-users"></i> Personnel Directory</h1>
        {% if user.is_superuser or 'Admin' in user.groups.all|join:',' %}
        <a href="{% url 'armguard_admin:registration' %}" class="btn-primary">
            <i class="fas fa-plus"></i> Register Personnel
        </a>
        {% endif %}
    </div>

    <!-- Statistics Dashboard -->
    <div class="stats-container">
        <div class="stat-card officers">
            <div class="stat-head">
                <div class="stat-label">Officers</div>
                <div class="stat-value" id="officerCount">0</div>
            </div>
        </div>
        <div class="stat-card enlisted">
            <div class="stat-head">
                <div class="stat-label">Enlisted</div>
                <div class="stat-value" id="enlistedCount">0</div>
            </div>
        </div>
        <div class="stat-card active">
            <div class="stat-head">
                <div class="stat-label">Active</div>
                <div class="stat-value" id="activeCount">0</div>
            </div>
        </div>
        <div class="stat-card total">
            <div class="stat-head">
                <div class="stat-label">Total Personnel</div>
                <div class="stat-value" id="totalCount">{{ total_count|default:0 }}</div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="filter-bar">
        <form method="get" class="filter-row">
            <div class="search-box">
                <input type="text" 
                       id="personnel-search" 
                       name="search_query" 
                       placeholder="üîç Search by name, rank, serial, or group..." 
                       value="{{ request.GET.search_query|default:'' }}">
            </div>
            <button type="submit" class="btn-primary">Search</button>
            <a href="{% url 'personnel:personnel_profile_list' %}" class="btn-secondary">Clear</a>
        </form>
        
        <!-- Quick Filters -->
        <div class="quick-filters">
            <span class="filter-chip" data-filter="all-status">All Status</span>
            <span class="filter-chip" data-filter="all-ranks">All Ranks</span>
            <span class="filter-chip" data-filter="officers">üë®‚Äç‚úàÔ∏è Officers</span>
            <span class="filter-chip" data-filter="enlisted">üéñÔ∏è Enlisted</span>
            <span class="filter-chip" data-filter="active">‚úÖ Active</span>
        </div>
    </div>

    <!-- Personnel Table -->
    <div class="personnel-table">
        <div class="table-header">
            <div class="table-title">
                <h3>Personnel Directory</h3>
                <span class="count-badge">Total: <span id="personnel-count">{{ total_count|default:0 }}</span></span>
            </div>
        </div>
        <div class="table-wrapper">
            <table id="personnel-table">
                <thead>
                    <tr>
                        <th class="sortable">Photo</th>
                        <th class="sortable">Name</th>
                        <th class="sortable">Rank</th>
                        <th class="sortable">ID/Serial</th>
                        <th class="sortable">Group</th>
                        <th class="sortable">Status</th>
                        <th class="sortable">Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for person in page_obj %}
                    <tr data-status="{{ person.status|lower }}" 
                        data-rank="{% if person.classification == 'OFFICER' %}officer{% elif person.classification == 'SUPERUSER' %}superuser{% else %}enlisted{% endif %}" 
                        data-group="{{ person.group }}" 
                        data-search="{{ person.get_full_name|lower }} {{ person.rank|lower }} {{ person.serial|lower }} {{ person.group|lower }}">
                        <td>
                            {% if person.picture %}
                            <img src="{{ person.picture.url }}" alt="{{ person.get_full_name }}" class="personnel-picture">
                            {% else %}
                            <div style="width: 50px; height: 50px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 0.8rem;">
                                <i class="fas fa-user"></i>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ person.get_full_name }}</strong>
                            <br><small style="color: #666;">ID: {{ person.id }}</small>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                {% if person.classification == 'OFFICER' %}
                                <i class="fas fa-star" style="color: #f59e0b;"></i>
                                {% elif person.classification == 'SUPERUSER' %}
                                <i class="fas fa-crown" style="color: #dc2626;"></i>
                                {% else %}
                                <i class="fas fa-chevron-up" style="color: #10b981;"></i>
                                {% endif %}
                                {% if person.classification == 'SUPERUSER' %}
                                    SUPERUSER
                                {% else %}
                                    {{ person.rank }}
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <strong>{{ person.get_serial_display }}</strong>
                            {% if person.classification == 'OFFICER' %}
                            <br><span class="badge badge-officer">Officer</span>
                            {% elif person.classification == 'SUPERUSER' %}
                            <br><span class="badge badge-superuser">Superuser</span>
                            {% else %}
                            <br><span class="badge badge-enlisted">Enlisted</span>
                            {% endif %}
                        </td>
                        <td>{{ person.group }}</td>
                        <td>
                            {% if person.status == 'Active' or person.status == 'ACTIVE' %}
                            <span class="badge badge-active">‚úÖ Active</span>
                            {% else %}
                            <span class="badge badge-inactive">‚ùå {{ person.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ person.tel|default:"-" }}</td>
                        <td>
                            <div class="action-links">
                                <a href="{% url 'personnel:personnel_profile_detail' person.id %}">View</a>
                                {% if user.is_superuser or 'Admin' in user.groups.all|join:',' %}
                                    <a href="{% url 'armguard_admin:registration' %}">Edit</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                                <h3>No personnel found</h3>
                                <p>
                                    {% if request.GET.search_query %}
                                        No personnel match your search criteria.
                                    {% else %}
                                        No personnel records have been created yet.
                                    {% endif %}
                                </p>
                                {% if user.is_superuser or 'Admin' in user.groups.all|join:',' %}
                                <a href="{% url 'armguard_admin:registration' %}" class="btn-primary">
                                    <i class="fas fa-plus"></i> Register Personnel
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('personnel-search');
    
    if (searchInput) {
        searchInput.addEventListener('input', debounce(function() {
            filterTable('personnel-table', this.value);
        }, 300));
    }
    
    // Quick filter chips
    const filterChips = document.querySelectorAll('.filter-chip');
    filterChips.forEach(chip => {
        chip.addEventListener('click', function() {
            // Toggle active class
            const isActive = this.classList.contains('active');
            filterChips.forEach(c => c.classList.remove('active'));
            
            if (!isActive) {
                this.classList.add('active');
                const filterValue = this.dataset.filter;
                
                if (filterValue === 'officers') {
                    applyQuickFilter('data-rank', ['officer']);
                } else if (filterValue === 'enlisted') {
                    applyQuickFilter('data-rank', ['enlisted']);
                } else if (filterValue === 'active') {
                    applyQuickFilter('data-status', ['active']);
                } else if (filterValue === 'all-status' || filterValue === 'all-ranks') {
                    const rows = document.querySelectorAll('#personnel-table tbody tr');
                    rows.forEach(row => row.style.display = '');
                }
            } else {
                const rows = document.querySelectorAll('#personnel-table tbody tr');
                rows.forEach(row => row.style.display = '');
            }
            updateCount('personnel-table', 'personnel-count');
            updateStatistics();
        });
    });
    
    // Initial statistics update
    updateStatistics();
    updateCount('personnel-table', 'personnel-count');
});

// Debounce function for search input
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

// Filter table based on search input
function filterTable(tableId, searchTerm) {
    const rows = document.querySelectorAll(`#${tableId} tbody tr`);
    const term = searchTerm.toLowerCase();
    
    rows.forEach(row => {
        const searchData = row.getAttribute('data-search');
        if (searchData && searchData.includes(term)) {
            row.style.display = '';
        } else if (term === '') {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    updateCount(tableId, 'personnel-count');
}

// Apply quick filter
function applyQuickFilter(attribute, values) {
    const rows = document.querySelectorAll('#personnel-table tbody tr');
    
    rows.forEach(row => {
        const attrValue = row.getAttribute(attribute);
        if (values.includes(attrValue)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Update visible count
function updateCount(tableId, countId) {
    const visibleRows = document.querySelectorAll(`#${tableId} tbody tr:not([style*="display: none"])`);
    // Filter out empty state rows
    const dataRows = Array.from(visibleRows).filter(row => row.getAttribute('data-status') !== null);
    const countElement = document.getElementById(countId);
    if (countElement) {
        countElement.textContent = dataRows.length;
    }
}

// Update statistics
function updateStatistics() {
    const allDataRows = document.querySelectorAll('#personnel-table tbody tr[data-status]');
    
    let officers = 0, enlisted = 0, active = 0, superusers = 0;
    
    allDataRows.forEach(row => {
        const rank = row.getAttribute('data-rank');
        const status = row.getAttribute('data-status');

        if (rank === 'officer') officers++;
        else if (rank === 'enlisted') enlisted++;
        else if (rank === 'superuser') superusers++;

        if (status === 'active') active++;
    });
    
    // Total includes officers + enlisted + superusers
    const total = officers + enlisted + superusers;
    
    // Update stat counters
    const officerCount = document.getElementById('officerCount');
    const enlistedCount = document.getElementById('enlistedCount');
    const activeCount = document.getElementById('activeCount');
    const totalCount = document.getElementById('totalCount');
    
    if (officerCount) officerCount.textContent = officers;
    if (enlistedCount) enlistedCount.textContent = enlisted;
    if (activeCount) activeCount.textContent = active;
    if (totalCount) totalCount.textContent = total;
}
</script>
{% endblock %}
