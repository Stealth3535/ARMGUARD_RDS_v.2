{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - ArmGuard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Minimal custom styles - most styling comes from design system */
    .no-results {
        text-align: center;
        color: var(--neutral-500);
        padding: var(--space-8);
        display: none;
    }
    
    .no-results.visible {
        display: block;
    }
    
    .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-4);
        padding: var(--space-4);
        border-bottom: var(--border) solid var(--neutral-200);
        transition: background var(--transition-fast);
    }
    
    .transaction-item:hover {
        background: var(--neutral-50);
        border-radius: var(--radius-md);
    }
    
    .transaction-item:last-child {
        border-bottom: none;
    }
    
    @media (max-width: 768px) {
        .transaction-item {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="card mb-6 border-l-4" style="border-left-color: var(--armguard-primary);">
    <div class="p-6">
        <h1 class="text-3xl font-bold text-neutral-900 m-0"><i class="fas fa-shield-alt text-primary"></i> Admin Dashboard</h1>
        <p class="text-base text-neutral-600 mt-2 mb-0">Centralized administration and management system</p>
    </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-4 gap-4 mb-6">
    <div class="stat-card primary">
        <div class="stat-card-icon"><i class="fas fa-users"></i></div>
        <div class="stat-card-content">
            <span class="stat-card-label">Users</span>
            <span class="stat-card-value">{{ users_count }}</span>
            <span class="stat-card-description">{{ active_users_count }} active user{{ active_users_count|pluralize }}</span>
        </div>
    </div>
    
    <div class="stat-card success">
        <div class="stat-card-icon"><i class="fas fa-id-card"></i></div>
        <div class="stat-card-content">
            <span class="stat-card-label">Personnel</span>
            <span class="stat-card-value">{{ personnel_count }}</span>
            <span class="stat-card-description">{{ enlisted_count }} enlisted, {{ officer_count }} officer{{ officer_count|pluralize }}</span>
        </div>
    </div>
    
    <div class="stat-card warning">
        <div class="stat-card-icon"><i class="fas fa-user-shield"></i></div>
        <div class="stat-card-content">
            <span class="stat-card-label">Administrators</span>
            <span class="stat-card-value">{{ administrators_count }}</span>
            <span class="stat-card-description">{{ superusers_count }} superuser{{ superusers_count|pluralize }}, {{ admins_count }} admin{{ admins_count|pluralize }}</span>
        </div>
    </div>
    
    <div class="stat-card danger">
        <div class="stat-card-icon"><i class="fas fa-shield-alt"></i></div>
        <div class="stat-card-content">
            <span class="stat-card-label">Armorers</span>
            <span class="stat-card-value">{{ armorers_count }}</span>
            <span class="stat-card-description">Active armorer accounts</span>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mb-6">
    <div class="p-6">
        <h2 class="text-xl font-bold text-neutral-900 mb-4 mt-0"><i class="fas fa-bolt text-warning-600"></i> Quick Actions</h2>
        <div class="grid grid-cols-3 gap-3">
            {% if can_edit and user.is_superuser or is_admin_group %}
            <a href="{% url 'armguard_admin:registration' %}" class="btn btn-success btn-block">
                <i class="fas fa-user-plus"></i> Register User/Personnel
            </a>
            <a href="{% url 'armguard_admin:user_management' %}" class="btn btn-primary btn-block">
                <i class="fas fa-users-cog"></i> Manage Users
            </a>
            {% elif is_admin_group %}
            <a href="{% url 'armguard_admin:user_management' %}" class="btn btn-primary btn-block">
                <i class="fas fa-users"></i> View Users (Read Only)
            </a>
            {% endif %}
            
            <a href="{% url 'personnel:personnel_profile_list' %}" class="btn btn-secondary btn-block">
                <i class="fas fa-id-card"></i> View Personnel
            </a>
            
            {% if can_edit and user.is_superuser or is_admin_group or is_armorer_group %}
            <a href="{% url 'armguard_admin:register_item' %}" class="btn btn-info btn-block">
                <i class="fas fa-plus-square"></i> Add Item
            </a>
            {% endif %}
            
            {% if can_edit and user.is_superuser or is_admin_group %}
            <a href="{% url 'armguard_admin:system_settings' %}" class="btn btn-secondary btn-block">
                <i class="fas fa-cog"></i> System Settings
            </a>
            {% endif %}
            
            {% if user.is_superuser %}
            <a href="{% url 'armguard_admin:audit_logs' %}" class="btn btn-secondary btn-block">
                <i class="fas fa-list-alt"></i> Audit Logs
            </a>
            
            <a href="/superadmin/" class="btn btn-danger btn-block" target="_blank">
                <i class="fas fa-tools"></i> Django Admin
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Filter & Search Box -->
<div class="card mb-6">
    <div class="p-6">
        <h2 class="text-xl font-bold text-neutral-900 mb-4 mt-0"><i class="fas fa-filter text-primary"></i> Filter & Search Transactions</h2>
        <div class="grid grid-cols-3 gap-4">
            <div>
                <label class="form-label"><i class="fas fa-search"></i> Search Personnel or Item</label>
                <input type="text" id="searchInput" class="form-input" placeholder="Search by name, serial, or item...">
            </div>
            
            <div>
                <label class="form-label"><i class="fas fa-calendar"></i> Time Range</label>
                <div class="flex gap-2">
                    <a href="?history=day" class="pill {% if selected_history == 'day' %}pill-primary{% else %}pill-secondary{% endif %}">Day</a>
                    <a href="?history=week" class="pill {% if selected_history == 'week' %}pill-primary{% else %}pill-secondary{% endif %}">Week</a>
                    <a href="?history=month" class="pill {% if selected_history == 'month' %}pill-primary{% else %}pill-secondary{% endif %}">Month</a>
                </div>
            </div>
            
            <div>
                <label class="form-label"><i class="fas fa-sort"></i> Sort By</label>
                <select id="sortSelect" class="form-input">
                    <option value="date-desc">Newest First</option>
                    <option value="date-asc">Oldest First</option>
                    <option value="personnel">Personnel Name</option>
                    <option value="action">Action Type</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="card mb-6">
    <div class="p-6">
        <div class="flex justify-between align-center mb-4">
            <h2 class="text-xl font-bold text-neutral-900 mt-0 mb-0"><i class="fas fa-clock text-info-600"></i> Recent Activity</h2>
            <div class="flex gap-2">
                <a href="{% url 'print_handler:print_transactions' %}?mode=defcon&range={{ selected_history }}" class="btn btn-danger btn-sm" target="_blank" rel="noopener">
                    <i class="fas fa-print"></i> DEFCON Summary
                </a>
                <a href="{% url 'print_handler:print_transactions' %}?mode=normal&range={{ selected_history }}" class="btn btn-primary btn-sm" target="_blank" rel="noopener">
                    <i class="fas fa-print"></i> NORMAL Summary
                </a>
            </div>
        </div>
        
        {% if recent_transactions %}
        <div id="transactionList">
            {% for transaction in recent_transactions %}
            <div class="transaction-item"
                data-personnel="{{ transaction.personnel.get_full_name|lower }}"
                data-serial="{{ transaction.personnel.serial|default:'' }}"
                data-item="{{ transaction.item.item_type|lower }} {{ transaction.item.serial|lower }}"
                data-action="{{ transaction.action|lower }}"
                data-date="{{ transaction.date_time|date:'Y-m-d H:i:s' }}">
                <div>
                    <div class="font-semibold text-neutral-900">{{ transaction.personnel.get_full_name }}</div>
                    <div class="text-sm text-neutral-600">
                        ({{ transaction.personnel.rank }} | {{ transaction.personnel.serial|default:"N/A" }})
                        - {{ transaction.item.item_type }} {{ transaction.item.serial }}
                    </div>
                    <div class="text-xs text-neutral-500 mt-1">{{ transaction.date_time|date:"M d, Y H:i" }}</div>
                </div>
                <div>
                    {% if transaction.action == "Take" %}
                        <span class="badge badge-warning">{{ transaction.action }} · {{ transaction.get_transaction_mode_display }}</span>
                    {% else %}
                        <span class="badge badge-success">{{ transaction.action }} · {{ transaction.get_transaction_mode_display }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="no-results" id="noResults">
            <i class="fas fa-search fa-2x mb-2"></i>
            <p>No transactions match your search.</p>
        </div>
        
        <div class="text-center mt-4">
            <a href="{% url 'transactions:list' %}" class="text-primary hover:underline">View all transactions →</a>
        </div>
        {% else %}
        <div class="text-center py-8 text-neutral-500">
            <i class="fas fa-inbox fa-2x mb-2"></i>
            <p>No recent transactions.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Issued Firearms Table -->
<div class="card">
    <div class="p-6">
        <h2 class="text-xl font-bold text-neutral-900 mb-4 mt-0"><i class="fas fa-shield-alt text-danger-600"></i> List of Issued Firearms</h2>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Firearm Serial</th>
                        <th>Type</th>
                        <th>Personnel</th>
                        <th>Personnel Serial</th>
                        <th>Issued Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in issued_assignments %}
                    <tr>
                        <td class="font-semibold">{{ assignment.item.serial }}</td>
                        <td>{{ assignment.item.item_type }}</td>
                        <td>{{ assignment.personnel.get_full_name }}</td>
                        <td>{{ assignment.personnel.serial|default:"N/A" }}</td>
                        <td>{{ assignment.date_time|date:"M d, Y H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-neutral-500">No firearms currently issued.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Search and Sort Functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const transactionList = document.getElementById('transactionList');
    const noResults = document.getElementById('noResults');
    
    if (!transactionList) return;
    
    const items = Array.from(transactionList.querySelectorAll('.transaction-item'));
    
    function filterAndSort() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const sortBy = sortSelect.value;
        
        // Filter
        let visibleItems = items.filter(item => {
            if (!searchTerm) return true;
            
            const personnel = item.dataset.personnel || '';
            const serial = item.dataset.serial || '';
            const itemData = item.dataset.item || '';
            
            return personnel.includes(searchTerm) || 
                   serial.includes(searchTerm) || 
                   itemData.includes(searchTerm);
        });
        
        // Sort
        visibleItems.sort((a, b) => {
            switch(sortBy) {
                case 'date-desc':
                    return new Date(b.dataset.date) - new Date(a.dataset.date);
                case 'date-asc':
                    return new Date(a.dataset.date) - new Date(b.dataset.date);
                case 'personnel':
                    return a.dataset.personnel.localeCompare(b.dataset.personnel);
                case 'action':
                    return a.dataset.action.localeCompare(b.dataset.action);
                default:
                    return 0;
            }
        });
        
        // Hide all items first
        items.forEach(item => item.style.display = 'none');
        
        // Show filtered and sorted items
        visibleItems.forEach(item => {
            item.style.display = 'flex';
            transactionList.appendChild(item);
        });
        
        // Show/hide no results message
        if (visibleItems.length === 0) {
            noResults.classList.add('visible');
        } else {
            noResults.classList.remove('visible');
        }
    }
    
    // Event listeners
    searchInput.addEventListener('input', filterAndSort);
    sortSelect.addEventListener('change', filterAndSort);
    
    // Initial sort
    filterAndSort();
});
</script>
{% endblock %}
