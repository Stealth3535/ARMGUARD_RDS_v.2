{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title|default:"Registration" }} - ArmGuard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'admin/css/universal-form.css' %}">
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-inner">
    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" style="animation: slideDown 0.3s ease;">
                {% if message.tags == 'success' %}
                    <i class="fas fa-check-circle"></i>
                {% elif message.tags == 'error' or message.tags == 'danger' %}
                    <i class="fas fa-exclamation-circle"></i>
                {% elif message.tags == 'warning' %}
                    <i class="fas fa-exclamation-triangle"></i>
                {% else %}
                    <i class="fas fa-info-circle"></i>
                {% endif %}
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- Header -->
    <div class="form-header">
        <h1>
            <span class="icon">
                {% if is_edit %}
                    ‚úèÔ∏è
                {% else %}
                    
                {% endif %}
            </span>
            {{ page_title|default:"Registration Form" }}
            {% if is_edit and edit_user %}
                {% if edit_user.is_superuser %}
                <span class="info-badge" style="background: #fee2e2; color: #991b1b;">üîê Superuser</span>
                {% elif edit_user.is_staff %}
                <span class="info-badge" style="background: #dbeafe; color: #1e40af;">üëî Admin</span>
                {% else %}
                <span class="info-badge" style="background: #d1fae5; color: #065f46;">üë§ Personnel</span>
                {% endif %}
            {% endif %}
        </h1>
        <p class="subtitle" style="color: #6b7280; font-size: 1rem;">
            {% if is_edit %}
                 Modify user account and personnel information with complete audit trail
            {% else %}
                 Register new users and personnel in the ArmGuard system
            {% endif %}
        </p>
    </div>
    
    <!-- Progress Indicator (for multi-step forms) -->
    {% if not is_edit %}
    <div class="form-progress">
        <div class="progress-step active">
            <div class="progress-step-circle">1</div>
            <div class="progress-step-label">Role Selection</div>
        </div>
        <div class="progress-step">
            <div class="progress-step-circle">2</div>
            <div class="progress-step-label">Account Info</div>
        </div>
        <div class="progress-step">
            <div class="progress-step-circle">3</div>
            <div class="progress-step-label">Personnel Data</div>
        </div>
        <div class="progress-step">
            <div class="progress-step-circle">4</div>
            <div class="progress-step-label">Review</div>
        </div>
    </div>
    {% endif %}
    
    <!-- Personnel Link Info (if editing and has personnel) -->
    {% if is_edit and edit_user.personnel %}
    <div class="personnel-info" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 1.25rem; border-radius: 10px; margin-bottom: 2rem; border: 2px solid #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 48px; height: 48px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                üîó
            </div>
            <div>
                <strong style="font-size: 1.0625rem; color: #065f46; display: block; margin-bottom: 0.25rem;">Linked Personnel Record</strong>
                <span style="color: #047857; font-size: 0.9375rem;">
                    {{ edit_user.personnel.firstname }} {{ edit_user.personnel.surname }} 
                    ({{ edit_user.personnel.rank }} - Serial: {{ edit_user.personnel.get_serial_display }})
                </span>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Form -->
    <form method="post" enctype="multipart/form-data" id="universalForm">
        {% csrf_token %}
        
        {# Hidden fields #}
        {{ form.operation_type }}
        {{ form.edit_user_id }}
        {{ form.edit_personnel_id }}
        
        <!-- Role Selection Section (show for new registration or when editing with proper authorization) -->
        {% if not is_edit or can_edit_role %}
        {% if not user_is_armorer %}
        <div class="form-section" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 2rem; border-radius: 12px; border-left: 4px solid #0284c7;">
            <h2>
                <span class="section-icon"></span>
                {% if is_edit %}
                User Role
                {% else %}
                Registration Type
                {% endif %}
            </h2>
            <div class="form-group">
                <label for="{{ form.role.id_for_label }}">
                    {{ form.role.label }} 
                    <span class="required-indicator" title="Required field"></span>
                    <span class="tooltip-trigger">‚ÑπÔ∏è
                        <span class="tooltip-content">{% if is_edit %}Change user's access level{% else %}Determines account access level{% endif %}</span>
                    </span>
                </label>
                {{ form.role }}
                <span class="help-text">
                    {% if is_edit %}
                        Change the role to modify user's access level (requires Superuser or Admin privileges)
                    {% else %}
                        Select the role to determine what type of registration will be performed
                    {% endif %}
                </span>
                {% if form.role.errors %}
                    <span class="error">{{ form.role.errors }}</span>
                {% endif %}
            </div>
            
            <div id="operationNotification" class="alert" style="display:none; padding: 1.25rem; border-radius: 10px; margin-top: 1.25rem; background: white; border: 2px solid #0284c7; box-shadow: 0 4px 12px rgba(2, 132, 199, 0.15);">
                <span id="operationText" style="font-size: 0.9375rem;"></span>
            </div>
        </div>
        {% else %}
        {# Hidden role field for armorers - always set to personnel #}
        <input type="hidden" name="role" value="personnel">
        <div class="alert alert-info" style="padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 48px; height: 48px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    üîß
                </div>
                <div>
                    <strong style="font-size: 1.125rem; color: #1e40af;">Armorer Mode</strong>
                    <p style="margin: 0.25rem 0 0 0; color: #1e40af;">You can register personnel records only. Contact an administrator for user account registration.</p>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
        
        <!-- Admin Restriction Field - Shown for both create and edit when role is Administrator -->
        <div class="form-group" id="adminRestrictionGroup" style="display:none; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid #f59e0b;">
            {% if is_superuser or not is_edit %}
            {# Superusers can always edit, non-superusers can only set during creation #}
            <label for="{{ form.admin_restriction.id_for_label }}">
                Administrator Access Level 
                <span class="required-indicator" title="Required field"></span>
                <span class="tooltip-trigger">‚ÑπÔ∏è
                    <span class="tooltip-content">Set permission level for admin</span>
                </span>
            </label>
            {{ form.admin_restriction }}
            <span class="help-text">Select access level for administrator accounts</span>
            {% if form.admin_restriction.errors %}
                <span class="error">{{ form.admin_restriction.errors }}</span>
            {% endif %}
            {% else %}
            {# Non-superusers editing existing admin - field is locked #}
            <label for="{{ form.admin_restriction.id_for_label }}">
                Administrator Access Level
            </label>
            <div class="form-field-disabled" style="background: white; padding: 1.25rem; border-radius: 8px; border: 2px solid #f59e0b; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 40px; height: 40px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                        üîí
                    </div>
                    <div>
                        <strong style="font-size: 1.0625rem; color: #92400e;">{{ form.admin_restriction.value|default:"No restriction" }}</strong>
                        <p style="margin: 0.25rem 0 0 0; color: #dc2626; font-size: 0.875rem;">
                            <i class="fas fa-lock"></i> Only superusers can modify existing admin restrictions
                        </p>
                    </div>
                </div>
            </div>
            <input type="hidden" name="admin_restriction" value="{{ form.admin_restriction.value }}">
            {% endif %}
        </div>
        
        <!-- Hidden role field for edit mode to help JavaScript -->
        {% if is_edit and edit_user %}
        <input type="hidden" id="hidden_role_value" value="{% if edit_user.is_superuser %}superuser{% elif edit_user.groups.all|first %}{{ edit_user.groups.all|first|lower }}{% else %}personnel{% endif %}">
        {% endif %}
        
        <!-- User Account Section -->
        <div class="form-section field-user-account" id="userAccountSection">
            <h2>
                <span class="section-icon">üë§</span>
                User Account Information
            </h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.username.id_for_label }}">
                        {{ form.username.label }} 
                        <span class="required-indicator" title="Required field"></span>
                    </label>
                    {{ form.username }}
                    <span class="help-text">Unique username for login</span>
                    {% if form.username.errors %}
                        <span class="error">{{ form.username.errors }}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.password.id_for_label }}">
                        {{ form.password.label }} 
                        {% if not is_edit %}<span class="required-indicator" title="Required field"></span>{% endif %}
                    </label>
                    {{ form.password }}
                    <span class="help-text">
                        {% if is_edit %}
                            Leave blank to keep current password
                        {% else %}
                            Minimum 8 characters with letters and numbers
                        {% endif %}
                    </span>
                    {% if form.password.errors %}
                        <span class="error">{{ form.password.errors }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.confirm_password.id_for_label }}">
                        {{ form.confirm_password.label }} 
                        {% if not is_edit %}<span class="required-indicator" title="Required field"></span>{% endif %}
                    </label>
                    {{ form.confirm_password }}
                    <span class="help-text">Re-enter password for confirmation</span>
                    {% if form.confirm_password.errors %}
                        <span class="error">{{ form.confirm_password.errors }}</span>
                    {% endif %}
                </div>
            </div>
                
                <div class="form-group">
                    <label for="{{ form.department.id_for_label }}">
                        {{ form.department.label }}
                    </label>
                    {{ form.department }}
                    <span class="help-text">Organizational unit or department</span>
                    {% if form.department.errors %}
                        <span class="error">{{ form.department.errors }}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 2px solid #e5e7eb;">
                    {{ form.is_active }}
                    <label for="{{ form.is_active.id_for_label }}" style="margin: 0; cursor: pointer; user-select: none;">
                        <strong>{{ form.is_active.label }}</strong>
                    </label>
                </div>
                <span class="help-text">Inactive users cannot log in to the system</span>
                {% if form.is_active.errors %}
                    <span class="error">{{ form.is_active.errors }}</span>
                {% endif %}
            </div>
        </div>
        
        <!-- Personnel Information Section -->
        <div class="form-section field-personnel-info" id="personnelInfoSection">
            <h2>
                <span class="section-icon"></span>
                Personnel Information
            </h2>
            
            <!-- Basic Info Subsection -->
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #10b981;">
                <h3 style="font-size: 1.125rem; color: #065f46; margin: 0 0 1rem 0; font-weight: 600;">
                    üë§ Basic Information
                </h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.surname.id_for_label }}">
                            {{ form.surname.label }} 
                            <span class="required-indicator" title="Required field"></span>
                        </label>
                        {{ form.surname }}
                        <span class="help-text">Last name (all capitals)</span>
                        {% if form.surname.errors %}
                            <span class="error">{{ form.surname.errors }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.firstname.id_for_label }}">
                            {{ form.firstname.label }} 
                            <span class="required-indicator" title="Required field"></span>
                        </label>
                        {{ form.firstname }}
                        <span class="help-text">First name (all capitals)</span>
                        {% if form.firstname.errors %}
                            <span class="error">{{ form.firstname.errors }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.middle_initial.id_for_label }}">
                            {{ form.middle_initial.label }}
                        </label>
                        {{ form.middle_initial }}
                        <span class="help-text">Middle initial only</span>
                        {% if form.middle_initial.errors %}
                            <span class="error">{{ form.middle_initial.errors }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.rank.id_for_label }}">
                            {{ form.rank.label }} 
                            <span class="required-indicator" title="Required field"></span>
                        </label>
                        {{ form.rank }}
                        <span class="help-text">Military rank</span>
                        {% if form.rank.errors %}
                            <span class="error">{{ form.rank.errors }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Military Info Subsection -->
            <div style="background: #eff6ff; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #2563eb;">
                <h3 style="font-size: 1.125rem; color: #1e40af; margin: 0 0 1rem 0; font-weight: 600;">
                    ü™ñ Military Details
                </h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.serial.id_for_label }}">
                            Serial Number 
                            <span class="required-indicator" title="Required field"></span>
                            <span class="tooltip-trigger">‚ÑπÔ∏è
                                <span class="tooltip-content">Enter numeric serial number only</span>
                            </span>
                        </label>
                        {{ form.serial }}
                        <span class="help-text">Numeric serial number (digits only)</span>
                        {% if form.serial.errors %}
                            <span class="error">{{ form.serial.errors }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.personnel_group.id_for_label }}">
                            {{ form.personnel_group.label }} 
                            <span class="required-indicator" title="Required field"></span>
                        </label>
                        {{ form.personnel_group }}
                        <span class="help-text">Unit or command group</span>
                        {% if form.personnel_group.errors %}
                            <span class="error">{{ form.personnel_group.errors }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.personnel_status.id_for_label }}">
                            {{ form.personnel_status.label }}
                        </label>
                        {{ form.personnel_status }}
                        <span class="help-text">Current duty status</span>
                        {% if form.personnel_status.errors %}
                            <span class="error">{{ form.personnel_status.errors }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Contact Info Subsection -->
            <div style="background: #fef3c7; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #f59e0b;">
                <h3 style="font-size: 1.125rem; color: #92400e; margin: 0 0 1rem 0; font-weight: 600;">
                    üìû Contact Information
                </h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.tel.id_for_label }}">
                            {{ form.tel.label }} 
                            <span class="required-indicator" title="Required field"></span>
                            <span class="tooltip-trigger">‚ÑπÔ∏è
                                <span class="tooltip-content">Auto-formats to +639XXXXXXXXX</span>
                            </span>
                        </label>
                        {{ form.tel }}
                        <span class="help-text">Philippine mobile number (auto-formatted)</span>
                        {% if form.tel.errors %}
                            <span class="error">{{ form.tel.errors }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.personnel_email.id_for_label }}">
                            {{ form.personnel_email.label }}
                            <span class="tooltip-trigger">‚ÑπÔ∏è
                                <span class="tooltip-content">Auto-corrects to @gmail.com</span>
                            </span>
                        </label>
                        {{ form.personnel_email }}
                        <span class="help-text">Personnel email (auto-corrects to @gmail.com)</span>
                        {% if form.personnel_email.errors %}
                            <span class="error">{{ form.personnel_email.errors }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Audit Documentation (Edit Only) -->
            {% if is_edit %}
            <div style="background: #fef2f2; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #dc2626;">
                <h3 style="font-size: 1.125rem; color: #991b1b; margin: 0 0 1rem 0; font-weight: 600;">
                    üìã Audit Documentation
                </h3>
                
                <div class="form-group">
                    <label for="{{ form.change_reason.id_for_label }}">
                        {{ form.change_reason.label }}
                        <span class="tooltip-trigger">‚ÑπÔ∏è
                            <span class="tooltip-content">Document why changes were made</span>
                        </span>
                    </label>
                    {{ form.change_reason }}
                    <span class="help-text">{{ form.change_reason.help_text }}</span>
                    {% if form.change_reason.errors %}
                        <span class="error">{{ form.change_reason.errors }}</span>
                    {% endif %}
                </div>
                
                <!-- Display Current Audit Context -->
                {% if edit_user.personnel %}
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                        <div>
                            <strong style="color: #6b7280;">Version:</strong>
                            <span style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">
                                v{{ edit_user.personnel.version|default:"1" }}
                            </span>
                        </div>
                        <div>
                            <strong style="color: #6b7280;">Created By:</strong>
                            <span>{{ edit_user.personnel.created_by|default:"System" }}</span>
                        </div>
                        <div>
                            <strong style="color: #6b7280;">Modified By:</strong>
                            <span>{{ edit_user.personnel.modified_by|default:"N/A" }}</span>
                        </div>
                        <div>
                            <strong style="color: #6b7280;">Last Updated:</strong>
                            <span>{{ edit_user.personnel.updated_at|date:"Y-m-d H:i" }}</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Personnel Picture -->
            <div style="background: #f3f4f6; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #9ca3af;">
                <h3 style="font-size: 1.125rem; color: #374151; margin: 0 0 1rem 0; font-weight: 600;">
                    üì∑ Personnel Photo
                </h3>
                
                <div class="form-group">
                    <label for="{{ form.personnel_picture.id_for_label }}">
                        {{ form.personnel_picture.label }}
                    </label>
                    {{ form.personnel_picture }}
                    <span class="help-text">Upload a clear photo (JPG, PNG, max 2MB)</span>
                    {% if is_edit and edit_user.personnel and edit_user.personnel.picture %}
                        <div class="current-image" style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                            <small style="display: block; color: #6b7280; margin-bottom: 0.5rem; font-weight: 600;">Current Photo:</small>
                            <img src="{{ edit_user.personnel.picture.url }}" alt="Personnel Photo" style="max-height: 150px; border-radius: 8px; border: 3px solid #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        </div>
                    {% endif %}
                    {% if form.personnel_picture.errors %}
                        <span class="error">{{ form.personnel_picture.errors }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="form-actions" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2.5rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
            <button type="submit" class="btn btn-primary" style="min-width: 150px; padding: 1rem 2rem; font-size: 1.0625rem;">
                {% if is_edit %}
                    <i class="fas fa-save" style="margin-right: 0.5rem;"></i>
                    {{ submit_text|default:"Save Changes" }}
                {% else %}
                    <i class="fas fa-user-plus" style="margin-right: 0.5rem;"></i>
                 {{ submit_text|default:"Register" }}
                {% endif %}
            </button>
            <a href="{% if is_edit %}{% url 'armguard_admin:user_management' %}{% else %}{% url 'armguard_admin:dashboard' %}{% endif %}" 
               class="btn btn-secondary" 
               style="min-width: 120px; padding: 1rem 2rem; font-size: 1.0625rem; text-decoration: none; text-align: center;">
                <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                Cancel
            </a>
        </div>
    </form>
</div>

{% block extra_js %}
<script src="{% static 'admin/js/universal-form.js' %}"></script>
{% endblock %}
{% endblock %}


