{% extends 'base.html' %}

{% block title %}View Device Request - ArmGuard{% endblock %}

{% block content %}
<div style="max-width: 860px; margin: 2rem auto; background: #fff; border-radius: 12px; padding: 1.75rem; box-shadow: 0 6px 20px rgba(0,0,0,0.08);">
    <h2 style="margin-top: 0;">ğŸ–¥ï¸ Device Request Details</h2>

    <!-- â”€â”€ Status Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    {% if auth_request.status == 'approved' %}
    <div style="padding:0.65rem 1rem; border-radius:8px; background:#f0fdf4; border:1px solid #bbf7d0; color:#14532d; font-weight:700; margin-bottom:1rem;">
        âœ… APPROVED â€” by {{ auth_request.reviewed_by.username|default:'N/A' }} on {{ auth_request.reviewed_at|date:"M d, Y H:i"|default:'N/A' }}
        {% if auth_request.review_notes %} &nbsp;Â·&nbsp; <em style="font-weight:400;">{{ auth_request.review_notes }}</em>{% endif %}
    </div>
    {% elif auth_request.status == 'rejected' %}
    <div style="padding:0.65rem 1rem; border-radius:8px; background:#fef2f2; border:1px solid #fecaca; color:#7f1d1d; font-weight:700; margin-bottom:1rem;">
        âŒ REJECTED â€” by {{ auth_request.reviewed_by.username|default:'N/A' }} on {{ auth_request.reviewed_at|date:"M d, Y H:i"|default:'N/A' }}
        {% if auth_request.review_notes %} &nbsp;Â·&nbsp; <em style="font-weight:400;">{{ auth_request.review_notes }}</em>{% endif %}
    </div>
    {% else %}
    <div style="padding:0.65rem 1rem; border-radius:8px; background:#fffbeb; border:1px solid #fcd34d; color:#78350f; font-weight:700; margin-bottom:1rem;">
        â³ PENDING â€” submitted {{ auth_request.requested_at|date:"M d, Y H:i" }}
    </div>
    {% endif %}

    <style>
        .req-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        @media (max-width: 600px) { .req-grid { grid-template-columns: 1fr; } }
        .req-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; }
        .req-card h4 { margin: 0 0 0.6rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: .05em; color: #6b7280; }
        .req-row { display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; gap: 0.5rem; }
        .req-row:last-child { border-bottom: none; }
        .req-label { color: #6b7280; white-space: nowrap; min-width: 120px; }
        .req-value { color: #111827; word-break: break-all; text-align: right; }
        .badge { display: inline-block; padding: 0.2rem 0.55rem; border-radius: 999px; font-size: 0.78rem; font-weight: 700; }
        .badge-green  { background:#dcfce7; color:#14532d; }
        .badge-yellow { background:#fef9c3; color:#713f12; }
        .badge-red    { background:#fee2e2; color:#7f1d1d; }
        .badge-blue   { background:#dbeafe; color:#1e3a8a; }
        details summary { cursor: pointer; color: #2563eb; font-size: 0.88rem; font-weight: 600; padding: 0.35rem 0; user-select: none; }
        details summary:hover { color: #1d4ed8; }
        pre.pem-block { background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; padding: 0.75rem; font-size: 0.72rem; overflow-x: auto; white-space: pre-wrap; word-break: break-all; margin: 0.5rem 0 0; }
        .spec-pill { display: inline-block; background: #e0f2fe; color: #0c4a6e; border-radius: 999px; padding: 0.15rem 0.6rem; font-size: 0.78rem; margin: 0.15rem; }
    </style>

    <!-- â”€â”€ Row 1: Hardware & Request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="req-grid">
        <!-- Hardware card -->
        <div class="req-card">
            <h4>ğŸ–¥ï¸ Hardware / Network</h4>
            <div class="req-row"><span class="req-label">Hostname</span><span class="req-value">{{ auth_request.hostname|default:'â€”' }}</span></div>
            <div class="req-row"><span class="req-label">Device Name</span><span class="req-value">{{ auth_request.device_name|default:'â€”' }}</span></div>
            <div class="req-row"><span class="req-label">IP Address</span><span class="req-value">{{ auth_request.ip_address }}</span></div>
            <div class="req-row"><span class="req-label">MAC Address</span>
                <span class="req-value">
                    {% if auth_request.mac_address %}
                        <code style="font-size:0.85rem;">{{ auth_request.mac_address }}</code>
                    {% else %}<em style="color:#9ca3af;">Not provided</em>{% endif %}
                </span>
            </div>
            <div class="req-row"><span class="req-label">PC Username</span>
                <span class="req-value">
                    {% if auth_request.pc_username %}
                        <code style="font-size:0.85rem;">{{ auth_request.pc_username }}</code>
                    {% else %}<em style="color:#9ca3af;">Not provided</em>{% endif %}
                </span>
            </div>
            <div class="req-row"><span class="req-label">Fingerprint</span><span class="req-value" style="font-family:monospace;font-size:0.78rem;">{{ auth_request.device_fingerprint }}</span></div>
            {% if auth_request.system_specs %}
            <div style="margin-top:0.5rem;">
                {% if auth_request.system_specs.os %}<span class="spec-pill">ğŸ”§ OS: {{ auth_request.system_specs.os }}</span>{% endif %}
                {% if auth_request.system_specs.cpu_cores %}<span class="spec-pill">âš™ï¸ {{ auth_request.system_specs.cpu_cores }} cores</span>{% endif %}
                {% if auth_request.system_specs.ram_gb %}<span class="spec-pill">ğŸ’¾ {{ auth_request.system_specs.ram_gb }} GB RAM</span>{% endif %}
                {% if auth_request.system_specs.screen %}<span class="spec-pill">ğŸ–¥ï¸ {{ auth_request.system_specs.screen }}</span>{% endif %}
                {% if auth_request.system_specs.timezone %}<span class="spec-pill">ğŸ• {{ auth_request.system_specs.timezone }}</span>{% endif %}
                {% if auth_request.system_specs.lang %}<span class="spec-pill">ğŸŒ {{ auth_request.system_specs.lang }}</span>{% endif %}
            </div>
            <details style="margin-top:0.4rem;">
                <summary>Full system specs JSON</summary>
                <pre class="pem-block">{{ auth_request.system_specs|pprint }}</pre>
            </details>
            {% endif %}
            <div style="margin-top:0.5rem;"><span class="req-label" style="font-size:0.82rem;">User Agent</span>
                <p style="font-size:0.78rem;color:#6b7280;margin:0.2rem 0 0;word-break:break-all;">{{ auth_request.user_agent }}</p>
            </div>
        </div>

        <!-- Request card -->
        <div class="req-card">
            <h4>ğŸ“‹ Request</h4>
            <div class="req-row"><span class="req-label">Requested by</span><span class="req-value">{{ auth_request.requested_by.username }}</span></div>
            <div class="req-row"><span class="req-label">Email</span><span class="req-value" style="font-size:0.85rem;">{{ auth_request.requested_by.email|default:'â€”' }}</span></div>
            <div class="req-row"><span class="req-label">Requested at</span><span class="req-value">{{ auth_request.requested_at|date:"M d, Y H:i" }}</span></div>
            <div class="req-row"><span class="req-label">Security Level</span>
                <span class="req-value">
                    {% if auth_request.security_level == 'MILITARY' %}<span class="badge badge-red">{{ auth_request.security_level }}</span>
                    {% elif auth_request.security_level == 'HIGH' %}<span class="badge badge-yellow">{{ auth_request.security_level }}</span>
                    {% else %}<span class="badge badge-blue">{{ auth_request.security_level }}</span>{% endif %}
                </span>
            </div>
            <div class="req-row"><span class="req-label">Can Transact</span><span class="req-value">{% if auth_request.can_transact %}âœ… Yes{% else %}âŒ No{% endif %}</span></div>
            <div class="req-row"><span class="req-label">Max Daily Tx</span><span class="req-value">{{ auth_request.max_daily_transactions }}</span></div>
            <div style="margin-top:0.65rem;font-size:0.88rem;color:#374151;">
                <strong>Reason:</strong><br>
                <p style="margin:0.3rem 0 0;color:#4b5563;">{{ auth_request.reason }}</p>
            </div>
        </div>
    </div>

    <!-- â”€â”€ Row 2: Certificate / CSR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="req-card" style="margin-bottom:1rem;">
        <h4>ğŸ” Certificate / CSR</h4>
        <div style="display:flex;gap:1.5rem;flex-wrap:wrap;margin-bottom:0.5rem;">
            <div>
                <span class="req-label" style="font-size:0.82rem;">CSR on file</span><br>
                {% if auth_request.csr_pem %}
                    <span class="badge badge-green">âœ… Submitted</span>
                {% else %}
                    <span class="badge badge-yellow">âš ï¸ Not submitted</span>
                {% endif %}
            </div>
            <div>
                <span class="req-label" style="font-size:0.82rem;">Certificate issued</span><br>
                {% if auth_request.issued_certificate_pem %}
                    <span class="badge badge-green">âœ… Issued</span>
                    {% if auth_request.issued_certificate_issued_at %}
                        <span style="font-size:0.8rem;color:#6b7280;margin-left:0.4rem;">{{ auth_request.issued_certificate_issued_at|date:"M d, Y H:i" }}</span>
                    {% endif %}
                {% else %}
                    <span class="badge badge-yellow">â³ Pending</span>
                {% endif %}
            </div>
            {% if auth_request.issued_certificate_serial %}
            <div>
                <span class="req-label" style="font-size:0.82rem;">Cert Serial</span><br>
                <code style="font-size:0.82rem;">{{ auth_request.issued_certificate_serial }}</code>
            </div>
            {% endif %}
        </div>

        {% if auth_request.csr_pem %}
        <details>
            <summary>ğŸ“„ View CSR PEM (Certificate Signing Request)</summary>
            <pre class="pem-block">{{ auth_request.csr_pem }}</pre>
        </details>
        {% endif %}

        {% if auth_request.issued_certificate_pem %}
        <details style="margin-top:0.4rem;">
            <summary>ğŸ“œ View Issued Certificate PEM</summary>
            <pre class="pem-block">{{ auth_request.issued_certificate_pem }}</pre>
        </details>
        {% endif %}
    </div>

    {% if auth_request.status == 'approved' and not auth_request.csr_pem %}
    <!-- â”€â”€ Generate & Attach Certificate panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="csr-panel" style="margin:1.25rem 0; padding:1.25rem; border-radius:10px; background:#f0fdf4; border:2px solid #bbf7d0;">
        <h3 style="margin:0 0 0.5rem; color:#14532d; font-size:1rem;">ğŸ” Attach Client Certificate</h3>
        <p style="margin:0 0 1rem; color:#166534; font-size:0.9rem;">No certificate was submitted with this request. Generate one now â€” your private key will be saved locally and the CSR will be attached to this device record.</p>

        <div id="csr-status" style="display:flex; align-items:center; gap:0.6rem; margin-bottom:0.75rem;">
            <span id="csr-spinner" style="font-size:1.2rem; animation:spin 1s linear infinite; display:inline-block;">â³</span>
            <span id="csr-msg" style="font-size:0.9rem; color:#14532d; font-weight:600;">Checking secure device storageâ€¦</span>
        </div>

        <div id="csr-key-notice" style="display:none; margin-bottom:0.75rem; padding:0.6rem 0.8rem; border-radius:7px; background:#fffbeb; border:1px solid #fcd34d; color:#78350f; font-size:0.85rem;">
            ğŸ”‘ <strong>Two files saved to your Downloads folder:</strong><br>
            &bull; <code>armguard_device.key</code> â€” private key (keep secret)<br>
            &bull; <code>armguard_device.csr</code> â€” certificate request (record copy)<br>
            <div style="margin-top:0.45rem; padding:0.5rem 0.65rem; background:#fee2e2; border:1px solid #fca5a5; border-radius:5px; color:#7f1d1d; font-size:0.82rem;">
                âš ï¸ <strong>DO NOT delete <code>armguard_device.key</code> from Downloads.</strong>
                If browser data (Cookies &amp; site data) is cleared, the hidden backup is also wiped.
                The Downloads copy is then your <strong>only recovery option</strong>.
                Losing it permanently invalidates your certificate â€” a new request must be submitted.
            </div>
        </div>

        <form id="csr-form" method="post" action="{% url 'armguard_admin:attach_csr_to_device' auth_request.id %}">
            {% csrf_token %}
            <input type="hidden" id="hidden-csr-pem" name="csr_pem">
            <button type="submit" id="csr-attach-btn" disabled
                    style="padding:0.65rem 1.4rem; border:none; border-radius:8px; background:#16a34a; color:#fff; font-weight:700; font-size:0.95rem; cursor:not-allowed; opacity:0.5;">
                ğŸ“ Attach Certificate to Device
            </button>
        </form>
    </div>

    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    <script>
    (function () {
        'use strict';
        /* â”€â”€ Storage layer 1: IndexedDB (hidden, survives history/download clear) â”€â”€ */
        const DB_NAME='armguard-keystore',DB_VERSION=1,STORE='keys',RECORD_ID='device-keypair';
        const LS_KEY='armguard.device.keypair';  /* localStorage backup key */
        function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);r.onupgradeneeded=e=>e.target.result.createObjectStore(STORE,{keyPath:'id'});r.onsuccess=e=>res(e.target.result);r.onerror=e=>rej(e.target.error);});}
        /* â”€â”€ Storage layer 2: localStorage (independent bucket backup) â”€â”€ */
        function lsSave(rec){try{localStorage.setItem(LS_KEY,JSON.stringify(rec));}catch(e){}}
        function lsLoad(){try{const r=localStorage.getItem(LS_KEY);return r?JSON.parse(r):null;}catch(e){return null;}}
        async function loadStored(){
            try{const db=await openDB();const rec=await new Promise((res,rej)=>{const r=db.transaction(STORE,'readonly').objectStore(STORE).get(RECORD_ID);r.onsuccess=e=>res(e.target.result||null);r.onerror=e=>rej(e.target.error);});if(rec)return rec;}catch(e){}
            return lsLoad();
        }
        async function saveStored(rec){
            lsSave(rec);
            try{const db=await openDB();await new Promise((res,rej)=>{const r=db.transaction(STORE,'readwrite').objectStore(STORE).put({id:RECORD_ID,...rec});r.onsuccess=()=>res();r.onerror=e=>rej(e.target.error);});}catch(e){}
        }
        /* â”€â”€ ASN.1 / CSR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function encLen(l){return l<128?[l]:l<256?[0x81,l]:[0x82,(l>>8)&0xff,l&0xff];}
        function tlv(t,a){return[t,...encLen(a.length),...a];}
        function seq(a){return tlv(0x30,a);} function set_(a){return tlv(0x31,a);}
        function oid_(b){return tlv(0x06,b);} function bits_(a){return tlv(0x03,[0,...a]);}
        function ctx0_(a){return tlv(0xA0,a);} function null_(){return[0x05,0x00];} function int_(a){return tlv(0x02,a);}
        function toPEM(bytes,label){const b64=btoa(String.fromCharCode(...bytes));return`-----BEGIN ${label}-----\n${b64.match(/.{1,64}/g).join('\n')}\n-----END ${label}-----`;}
        function downloadPEM(pem,filename){const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([pem],{type:'application/x-pem-file'})),download:filename});document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},1000);}
        async function generateCSR(cn){
            const kp=await crypto.subtle.generateKey({name:'RSASSA-PKCS1-v1_5',modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:'SHA-256'},true,['sign','verify']);
            const privDer=new Uint8Array(await crypto.subtle.exportKey('pkcs8',kp.privateKey));
            const pubSpki=new Uint8Array(await crypto.subtle.exportKey('spki',kp.publicKey));
            function atv(o,v,t){t=t||0x0C;return seq([...oid_(o),...tlv(t,[...new TextEncoder().encode(v)])]);}
            const subject=seq([...set_(atv([0x55,0x04,0x06],'PH',0x13)),...set_(atv([0x55,0x04,0x0A],'9533 RDS Squadron')),...set_(atv([0x55,0x04,0x03],cn))]);
            const certReqInfo=seq([...int_([0x00]),...subject,...pubSpki,...ctx0_([])]);
            const sig=new Uint8Array(await crypto.subtle.sign({name:'RSASSA-PKCS1-v1_5'},kp.privateKey,new Uint8Array(certReqInfo)));
            const csr=seq([...certReqInfo,...seq([...oid_([0x2A,0x86,0x48,0x86,0xF7,0x0D,0x01,0x01,0x0B]),...null_()]),...bits_([...sig])]);
            return{csrPem:toPEM([...csr],'CERTIFICATE REQUEST'),privKeyPem:toPEM([...privDer],'PRIVATE KEY')};
        }
        async function init(){
            const spinner=document.getElementById('csr-spinner');
            const msg=document.getElementById('csr-msg');
            const panel=document.getElementById('csr-status');
            const notice=document.getElementById('csr-key-notice');
            const hiddenCsr=document.getElementById('hidden-csr-pem');
            const btn=document.getElementById('csr-attach-btn');
            const cn='{{ auth_request.device_name|escapejs }}'||'ArmGuard Device';
            try{
                /* â”€â”€ Check IndexedDB first â€” reuse if already stored on this machine â”€â”€ */
                const stored=await loadStored();
                if(stored && stored.csrPem && stored.cn===cn){
                    hiddenCsr.value=stored.csrPem;
                    spinner.style.animation='none';spinner.textContent='ğŸ”’';
                    msg.textContent='Existing certificate loaded from secure device storage â€” no re-download needed.';
                    msg.style.color='#1d4ed8';
                    panel.style.background='#eff6ff';panel.style.borderColor='#93c5fd';
                    btn.disabled=false;btn.style.opacity='1';btn.style.cursor='pointer';
                    return;
                }
                /* â”€â”€ No stored key â€” generate fresh â”€â”€ */
                const{csrPem,privKeyPem}=await generateCSR(cn);
                await saveStored({cn,csrPem,privKeyPem,created:Date.now()});
                hiddenCsr.value=csrPem;
                spinner.style.animation='none';spinner.textContent='âœ…';
                msg.textContent='Certificate secured on this device â€” private key & CSR saved to Downloads.';
                downloadPEM(privKeyPem,'armguard_device.key');
                setTimeout(()=>downloadPEM(csrPem,'armguard_device.csr'),600);
                notice.style.display='block';
                btn.disabled=false;btn.style.opacity='1';btn.style.cursor='pointer';
            }catch(e){
                spinner.textContent='âš ï¸';msg.textContent='Generation failed: '+e.message;msg.style.color='#b45309';
            }
        }
        document.readyState==='loading'?document.addEventListener('DOMContentLoaded',init):init();
    })();
    </script>
    {% endif %}

    <div style="display:flex; gap:0.75rem; flex-wrap: wrap;">
        <a href="{% url 'armguard_admin:manage_device_requests' %}" style="padding:0.7rem 1rem; border:1px solid #d1d5db; border-radius:8px; text-decoration:none; color:#374151;">Back</a>
        {% if auth_request.status == 'approved' %}
        <a href="{% url 'armguard_admin:edit_device_request' auth_request.id %}" style="padding:0.7rem 1rem; border:none; border-radius:8px; background:#16a34a; color:#fff; text-decoration:none; font-weight:600;">Edit</a>
        {% endif %}
    </div>
</div>
{% endblock %}
