{% extends 'base.html' %}
{% load static %}

{% block title %}{{ item.item_type }} - Item Detail{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'inventory/inventory.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .item-detail-container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }

    .breadcrumb-nav { font-size: 0.85rem; color: #9ca3af; margin-bottom: 0.9rem; }
    .breadcrumb-nav a { color: #6b7280; text-decoration: none; }
    .breadcrumb-nav a:hover { color: #1b5ad1; }

    /* ── Profile row ── */
    .profile-row { display: flex; gap: 1.2rem; align-items: flex-start; margin-bottom: 1rem; }

    /* ── Item card (left) ── */
    .item-id-card {
        width: 220px; min-width: 220px;
        background: #fff;
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        display: flex; flex-direction: column; align-items: center;
    }
    .item-card-top {
        width: 100%;
        background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        padding: 0.7rem 0 0.6rem;
        display: flex; flex-direction: column; align-items: center; gap: 0.4rem;
    }
    .item-card-logo {
        font-size: 0.65rem; font-weight: 800; letter-spacing: 0.12em;
        color: rgba(255,255,255,0.75); text-transform: uppercase;
    }
    .item-icon-circle {
        width: 70px; height: 70px; border-radius: 50%;
        background: rgba(255,255,255,0.15);
        border: 3px solid rgba(255,255,255,0.5);
        display: flex; align-items: center; justify-content: center;
        color: #fff; font-size: 1.8rem;
    }
    .item-card-body {
        width: 100%; padding: 0.7rem 1rem 0.6rem;
        display: flex; flex-direction: column; align-items: center; gap: 0.25rem; text-align: center;
    }
    .item-card-name {
        font-size: 1rem; font-weight: 800; color: #111827;
        text-transform: uppercase; letter-spacing: 0.03em; margin: 0; line-height: 1.2;
    }
    .item-card-serial {
        font-family: monospace; font-size: 0.75rem; color: #6b7280; margin: 0;
    }
    .item-card-badges { display: flex; gap: 0.3rem; flex-wrap: wrap; justify-content: center; margin-top: 0.2rem; }
    .badge-pill {
        display: inline-flex; align-items: center; gap: 0.2rem;
        padding: 0.15rem 0.6rem; border-radius: 999px;
        font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em;
    }
    .badge-rifle    { background: #dbeafe; color: #1e40af; }
    .badge-pistol   { background: #ede9fe; color: #5b21b6; }
    .badge-available   { background: #dcfce7; color: #166534; }
    .badge-issued      { background: #fef3c7; color: #92400e; }
    .badge-maintenance { background: #fee2e2; color: #991b1b; }
    .badge-retired     { background: #f3f4f6; color: #6b7280; }

    .item-card-footer {
        width: 100%; height: 52px; min-height: 52px;
        border-top: 1px solid #f3f4f6; background: #f9fafb;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        gap: 0.05rem; flex-shrink: 0;
    }
    .item-card-id-label {
        font-size: 0.6rem; font-weight: 700; text-transform: uppercase;
        letter-spacing: 0.08em; color: #9ca3af;
    }
    .item-card-id-value {
        font-family: monospace; font-size: 0.72rem; font-weight: 700;
        color: #374151; letter-spacing: 0.03em;
    }

    /* ── Info card (right) ── */
    .info-card {
        flex: 1; background: #fff; border-radius: 12px;
        padding: 1rem 1.2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .info-card-title {
        font-size: 0.78rem; font-weight: 700; text-transform: uppercase;
        letter-spacing: 0.06em; color: #6b7280;
        margin: 0 0 0.75rem 0; padding-bottom: 0.45rem;
        border-bottom: 1px solid #f3f4f6;
    }
    .info-rows { display: flex; flex-direction: column; gap: 0.4rem; }
    .info-row {
        display: grid; grid-template-columns: 130px 1fr;
        gap: 0.5rem; font-size: 0.88rem; align-items: baseline;
    }
    .info-label { color: #9ca3af; font-size: 0.8rem; font-weight: 600; }
    .info-value { color: #111827; font-weight: 500; word-break: break-word; }

    /* ── Action buttons ── */
    .item-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .btn-action {
        display: inline-flex; align-items: center; gap: 0.3rem;
        padding: 0.4rem 0.9rem; border-radius: 8px; font-size: 0.8rem;
        font-weight: 600; text-decoration: none; border: 1px solid #e5e7eb;
        background: #f3f4f6; color: #374151; cursor: pointer; transition: background 0.2s;
    }
    .btn-action:hover { background: #e5e7eb; }
    .btn-action.btn-edit  { background: #fef3c7; color: #92400e; border-color: #fde68a; }
    .btn-action.btn-del   { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
    .btn-action.btn-print { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }

    /* ── QR strip inside info card ── */
    .qr-strip {
        display: flex; align-items: center; gap: 1rem;
        padding: 0.6rem 0; border-top: 1px solid #f3f4f6; margin-top: 0.4rem;
    }
    .qr-strip img { width: 72px; height: 72px; border-radius: 6px; border: 1px solid #e5e7eb; }
    .qr-strip .no-qr {
        width: 72px; height: 72px; background: #f3f4f6; border-radius: 6px;
        display: flex; align-items: center; justify-content: center;
        color: #9ca3af; font-size: 0.7rem; text-align: center; border: 1px dashed #d1d5db;
    }

    /* ── Stencil ── */
    .stencil-thumb {
        width: 80px; height: 56px; border-radius: 6px; border: 1px solid #e5e7eb;
        object-fit: contain; background: #fff;
    }

    /* ── Transaction table ── */
    .tx-card {
        background: #fff; border-radius: 12px; padding: 1rem 1.2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 1rem;
    }
    .tx-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .tx-table th {
        text-align: left; padding: 0.4rem 0.6rem;
        font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
        letter-spacing: 0.04em; color: #6b7280; border-bottom: 1px solid #f3f4f6;
    }
    .tx-table td {
        padding: 0.45rem 0.6rem; color: #374151;
        border-bottom: 1px solid #f9fafb; vertical-align: middle;
    }
    .tx-table tr:last-child td { border-bottom: none; }
    .tx-badge {
        display: inline-block; padding: 0.15rem 0.55rem;
        border-radius: 999px; font-size: 0.72rem; font-weight: 700;
    }
    .tx-withdraw { background: #fef3c7; color: #92400e; }
    .tx-return   { background: #dcfce7; color: #166534; }

    /* ── Status change ── */
    .status-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="item-detail-container">

    <!-- Breadcrumb -->
    <div class="breadcrumb-nav">
        <a href="{% url 'dashboard' %}">Dashboard</a> /
        <a href="{% url 'inventory:item_list' %}">Inventory</a> /
        <strong>{{ item.item_type }}</strong>
    </div>

    <!-- Action buttons -->
    <div class="item-actions">
        <a href="{% url 'inventory:item_list' %}" class="btn-action"><i class="fas fa-arrow-left"></i> Back</a>
        {% if is_admin %}
        <a href="{% url 'armguard_admin:edit_item' item.id %}" class="btn-action btn-edit"><i class="fas fa-edit"></i> Edit</a>
        <a href="{% url 'armguard_admin:delete_item' item.id %}" class="btn-action btn-del"><i class="fas fa-trash"></i> Delete</a>
        {% endif %}
        {% if qr_code_obj %}
        <a href="{% url 'print_handler:print_single_qr' qr_code_obj.id %}" class="btn-action btn-print" target="_blank"><i class="fas fa-print"></i> Print QR</a>
        {% endif %}
        {% if item.status != 'Issued' and user.is_staff %}
        <form method="post" action="{% url 'inventory:update_item_status' item.pk %}" style="display:contents;">
            {% csrf_token %}
            {% if item.status != 'Available' %}
            <button type="submit" name="status" value="Available" class="btn-action" style="background:#dcfce7;color:#166534;border-color:#bbf7d0;"><i class="fas fa-check-circle"></i> Available</button>
            {% endif %}
            {% if item.status != 'Maintenance' %}
            <button type="submit" name="status" value="Maintenance" class="btn-action" style="background:#fee2e2;color:#991b1b;border-color:#fecaca;"><i class="fas fa-wrench"></i> Maintenance</button>
            {% endif %}
            {% if item.status != 'Retired' %}
            <button type="submit" name="status" value="Retired" class="btn-action" style="background:#f3f4f6;color:#6b7280;border-color:#e5e7eb;"><i class="fas fa-archive"></i> Retire</button>
            {% endif %}
        </form>
        {% endif %}
    </div>

    <!-- Profile row: item card left, info right -->
    <div class="profile-row">

        <!-- Item Card -->
        <div class="item-id-card">
            <div class="item-card-top">
                <span class="item-card-logo">ARMGUARD RDS</span>
                <div class="item-icon-circle">
                    {% if item.is_rifle %}<i class="fas fa-crosshairs"></i>{% else %}<i class="fas fa-bullseye"></i>{% endif %}
                </div>
            </div>
            <div class="item-card-body">
                <p class="item-card-name">{{ item.item_type }}</p>
                <p class="item-card-serial">{{ item.serial }}</p>
                <div class="item-card-badges">
                    {% if item.is_rifle %}
                    <span class="badge-pill badge-rifle"><i class="fas fa-crosshairs"></i> Rifle</span>
                    {% else %}
                    <span class="badge-pill badge-pistol"><i class="fas fa-bullseye"></i> Pistol</span>
                    {% endif %}
                    <span class="badge-pill badge-{{ item.status|lower }}">{{ item.status }}</span>
                </div>
            </div>
            <div class="item-card-footer">
                <span class="item-card-id-label">Item ID</span>
                <span class="item-card-id-value">{{ item.id }}</span>
            </div>
        </div>

        <!-- Info Card -->
        <div class="info-card">
            <p class="info-card-title"><i class="fas fa-info-circle" style="margin-right:0.35rem;"></i>Item Information</p>
            <div class="info-rows">
                <div class="info-row">
                    <span class="info-label">Item Type</span>
                    <span class="info-value"><strong>{{ item.item_type }}</strong></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Serial No.</span>
                    <span class="info-value" style="font-family:monospace;">{{ item.serial }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Condition</span>
                    <span class="info-value">{{ item.condition }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Description</span>
                    <span class="info-value">{% if item.description %}{{ item.description }}{% else %}<em style="color:#9ca3af;">—</em>{% endif %}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Registered</span>
                    <span class="info-value">{{ item.registration_date|date:"d/m/y" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Created</span>
                    <span class="info-value">{{ item.created_at|date:"d/m/y H:i" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Updated</span>
                    <span class="info-value">{{ item.updated_at|date:"d/m/y H:i" }}</span>
                </div>
                {% if item.stencil_picture %}
                <div class="info-row">
                    <span class="info-label">Stencil</span>
                    <span class="info-value">
                        <a href="{{ item.stencil_picture.url }}" target="_blank">
                            <img src="{{ item.stencil_picture.url }}" alt="Stencil" class="stencil-thumb">
                        </a>
                    </span>
                </div>
                {% endif %}
            </div>

            <!-- QR strip -->
            <div class="qr-strip">
                {% if qr_code_obj and qr_code_obj.qr_image %}
                <img src="{{ qr_code_obj.qr_image.url }}?v={{ qr_code_obj.updated_at|date:'U' }}" alt="QR">
                {% else %}
                <div class="no-qr"><i class="fas fa-qrcode"></i><br>No QR</div>
                {% endif %}
                <div>
                    <div class="info-label">QR Code</div>
                    <div style="font-family:monospace;font-size:0.75rem;color:#374151;word-break:break-all;">{{ item.qr_code }}</div>
                </div>
            </div>
        </div>

    </div><!-- end profile row -->

    <!-- Transaction History -->
    <div class="tx-card">
        <p class="info-card-title"><i class="fas fa-history" style="margin-right:0.35rem;"></i>Transaction History
            <span style="font-weight:400;color:#9ca3af;margin-left:0.5rem;">{{ item.transactions.count }} record{{ item.transactions.count|pluralize }}</span>
        </p>
        {% if item.transactions.exists %}
        <div style="overflow-x:auto;">
            <table class="tx-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Personnel</th>
                        <th>Action</th>
                        <th>Date/Time</th>
                        <th>Duty Type</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in item.transactions.all %}
                    <tr>
                        <td style="font-family:monospace;font-size:0.8rem;">{{ transaction.id }}</td>
                        <td>
                            <div style="font-weight:600;font-size:0.85rem;">{{ transaction.personnel.get_full_name }}</div>
                            <div style="font-size:0.75rem;color:#9ca3af;">{{ transaction.personnel.rank }}</div>
                        </td>
                        <td>
                            {% if transaction.action == 'Take' %}
                            <span class="tx-badge tx-withdraw"><i class="fas fa-arrow-right"></i> Withdraw</span>
                            {% else %}
                            <span class="tx-badge tx-return"><i class="fas fa-arrow-left"></i> Return</span>
                            {% endif %}
                        </td>
                        <td style="font-size:0.82rem;">
                            {{ transaction.date_time|date:"d/m/y" }}<br>
                            <span style="color:#9ca3af;">{{ transaction.date_time|date:"H:i" }}</span>
                        </td>
                        <td style="font-size:0.82rem;">{{ transaction.duty_type|default:"—" }}</td>
                        <td style="font-size:0.82rem;max-width:160px;">{{ transaction.notes|truncatechars:40|default:"—" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align:center;padding:2rem;color:#9ca3af;">
            <i class="fas fa-history" style="font-size:1.5rem;margin-bottom:0.5rem;display:block;"></i>
            No transactions recorded.
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}

