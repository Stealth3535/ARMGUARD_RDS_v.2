name: ARMGUARD Deployment A CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      target:
        description: Deployment target
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production
          - both

permissions:
  contents: read

concurrency:
  group: deployment-a-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-validate:
    name: Build and validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r armguard/requirements.txt
          pip install bandit

      - name: Django system checks
        working-directory: armguard
        run: |
          python manage.py check

      - name: Static security scan (Bandit)
        run: |
          bandit -r armguard -x armguard/venv,armguard/.venv,armguard/deployment_A/legacy_archive -ll

  deploy-staging:
    name: Deploy staging
    runs-on: ubuntu-latest
    needs: build-and-validate
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && (inputs.target == 'staging' || inputs.target == 'both'))
    environment: staging
    steps:
      - name: Deploy to staging host over SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_KEY }}
          SSH_HOST: ${{ secrets.STAGING_HOST }}
          SSH_USER: ${{ secrets.STAGING_USER }}
          STAGING_DEPLOY_COMMAND: ${{ secrets.STAGING_DEPLOY_COMMAND }}
        run: |
          if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$SSH_HOST" ] || [ -z "$SSH_USER" ] || [ -z "$STAGING_DEPLOY_COMMAND" ]; then
            echo "Missing one or more staging secrets: STAGING_SSH_KEY, STAGING_HOST, STAGING_USER, STAGING_DEPLOY_COMMAND"
            exit 1
          fi

          install -m 700 -d ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

          ssh "$SSH_USER@$SSH_HOST" "$STAGING_DEPLOY_COMMAND"

      - name: Post-deploy staging health check (optional)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_KEY }}
          SSH_HOST: ${{ secrets.STAGING_HOST }}
          SSH_USER: ${{ secrets.STAGING_USER }}
          STAGING_HEALTHCHECK_COMMAND: ${{ secrets.STAGING_HEALTHCHECK_COMMAND }}
        run: |
          if [ -z "$STAGING_HEALTHCHECK_COMMAND" ]; then
            echo "No STAGING_HEALTHCHECK_COMMAND provided; skipping health check"
            exit 0
          fi

          install -m 700 -d ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

          ssh "$SSH_USER@$SSH_HOST" "$STAGING_HEALTHCHECK_COMMAND"

  deploy-production:
    name: Deploy production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.target == 'production' || inputs.target == 'both'))
    environment: production
    steps:
      - name: Deploy to production host over SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
          SSH_HOST: ${{ secrets.PRODUCTION_HOST }}
          SSH_USER: ${{ secrets.PRODUCTION_USER }}
          PRODUCTION_DEPLOY_COMMAND: ${{ secrets.PRODUCTION_DEPLOY_COMMAND }}
        run: |
          if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$SSH_HOST" ] || [ -z "$SSH_USER" ] || [ -z "$PRODUCTION_DEPLOY_COMMAND" ]; then
            echo "Missing one or more production secrets: PRODUCTION_SSH_KEY, PRODUCTION_HOST, PRODUCTION_USER, PRODUCTION_DEPLOY_COMMAND"
            exit 1
          fi

          install -m 700 -d ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

          ssh "$SSH_USER@$SSH_HOST" "$PRODUCTION_DEPLOY_COMMAND"

      - name: Post-deploy production health check (optional)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
          SSH_HOST: ${{ secrets.PRODUCTION_HOST }}
          SSH_USER: ${{ secrets.PRODUCTION_USER }}
          PRODUCTION_HEALTHCHECK_COMMAND: ${{ secrets.PRODUCTION_HEALTHCHECK_COMMAND }}
        run: |
          if [ -z "$PRODUCTION_HEALTHCHECK_COMMAND" ]; then
            echo "No PRODUCTION_HEALTHCHECK_COMMAND provided; skipping health check"
            exit 0
          fi

          install -m 700 -d ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

          ssh "$SSH_USER@$SSH_HOST" "$PRODUCTION_HEALTHCHECK_COMMAND"
