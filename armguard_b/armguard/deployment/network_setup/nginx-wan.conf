# ============================================================================
# ArmGuard - WAN Network Configuration (Personnel Portal)
# ============================================================================
# This server block handles public personnel login and access
# using ZeroSSL/Let's Encrypt certificates with ACME auto-renewal
# ============================================================================

# Rate limiting zones for WAN (stricter than LAN)
limit_req_zone $binary_remote_addr zone=armguard_wan:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=armguard_wan_login:10m rate=3r/m;
limit_conn_zone $binary_remote_addr zone=armguard_wan_conn:10m;

upstream armguard_app_wan {
    server unix:/run/gunicorn-armguard.sock fail_timeout=0;
}

# ============================================================================
# HTTP Server Block - Redirect to HTTPS
# ============================================================================
server {
    listen 80;
    listen [::]:80;
    
    server_name login.yourdomain.com www.login.yourdomain.com;
    
    # Logging
    access_log /var/log/nginx/armguard_wan_http_access.log;
    error_log /var/log/nginx/armguard_wan_http_error.log;
    
    # ACME Challenge for certificate renewal
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/acme-challenge;
        default_type "text/plain";
        allow all;
    }
    
    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# ============================================================================
# HTTPS Server Block - Personnel Portal
# ============================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name login.yourdomain.com www.login.yourdomain.com;
    
    # ========================================================================
    # SSL Configuration (ZeroSSL/Let's Encrypt via ACME)
    # ========================================================================
    ssl_certificate /etc/letsencrypt/live/login.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/login.yourdomain.com/privkey.pem;
    
    # Modern SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305';
    ssl_prefer_server_ciphers off;
    
    # SSL session cache
    ssl_session_cache shared:SSL_WAN:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    
    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/login.yourdomain.com/chain.pem;
    
    # DNS resolver for OCSP
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # HSTS (6 months)
    add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload" always;
    
    # ========================================================================
    # Security Headers (Strict for Public Internet)
    # ========================================================================
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
    
    # ========================================================================
    # Access Control - Public but rate-limited
    # ========================================================================
    # No IP restrictions (public portal), but strict rate limiting
    
    # ========================================================================
    # Client Settings
    # ========================================================================
    client_max_body_size 5M;  # Smaller for personnel uploads
    client_body_timeout 30s;
    client_header_timeout 30s;
    
    # Connection limit: 5 per IP (prevent abuse)
    limit_conn armguard_wan_conn 5;
    
    # ========================================================================
    # Logging (separate logs for WAN)
    # ========================================================================
    access_log /var/log/nginx/armguard_wan_access.log;
    error_log /var/log/nginx/armguard_wan_error.log warn;
    
    # ========================================================================
    # Static Files (cached aggressively)
    # ========================================================================
    location /static/ {
        alias /var/www/armguard/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Rate limit static files
        limit_req zone=armguard_wan burst=20 nodelay;
    }
    
    # ========================================================================
    # BLOCK Admin Panel on WAN (security measure)
    # ========================================================================
    location ~* ^/admin.*$ {
        # Admin panel should ONLY be accessible via LAN
        deny all;
        return 403;
    }
    
    # ========================================================================
    # BLOCK Inventory/Armory endpoints on WAN
    # ========================================================================
    location ~* ^/(inventory|transactions|qr-manager).*$ {
        # These should ONLY be accessible via LAN
        deny all;
        return 403;
    }
    
    # ========================================================================
    # Login/Authentication Endpoints (VERY strict rate limiting)
    # ========================================================================
    location ~* ^/(login|logout|password-reset|register).*$ {
        # Extremely strict rate limiting
        limit_req zone=armguard_wan_login burst=2 nodelay;
        
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Network-Type "WAN";  # Custom header
        
        proxy_redirect off;
        proxy_buffering off;
        
        proxy_pass http://armguard_app_wan;
    }
    
    # ========================================================================
    # Personnel-Only Pages (rate limited)
    # ========================================================================
    location ~* ^/(personnel|profile|dashboard).*$ {
        # Moderate rate limiting
        limit_req zone=armguard_wan burst=10 nodelay;
        
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Network-Type "WAN";
        
        # Standard timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        proxy_redirect off;
        proxy_buffering off;
        
        proxy_pass http://armguard_app_wan;
    }
    
    # ========================================================================
    # Root and general pages
    # ========================================================================
    location / {
        # General rate limiting
        limit_req zone=armguard_wan burst=10 nodelay;
        
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Network-Type "WAN";
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        proxy_redirect off;
        proxy_buffering off;
        
        proxy_pass http://armguard_app_wan;
    }
    
    # ========================================================================
    # Health Check (limited)
    # ========================================================================
    location /health/ {
        limit_req zone=armguard_wan burst=5 nodelay;
        access_log off;
        proxy_pass http://armguard_app_wan;
    }
    
    # ========================================================================
    # Block unauthorized file types and exploits
    # ========================================================================
    location ~* (\.php|\.asp|\.aspx|\.jsp|\.cgi)$ {
        deny all;
        return 444;
    }
    
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Block common exploit paths
    location ~* (wp-admin|wordpress|phpmyadmin|xmlrpc) {
        deny all;
        return 444;
    }
}
